"use strict";
var Capabilities;
(function (Capabilities) {
    Capabilities["REL1XX"] = "REL1XX";
    Capabilities["FORKING"] = "FORKING";
    Capabilities["PRECONDITION"] = "PRECONDITION";
    Capabilities["PEM"] = "PEM";
    Capabilities["UPDATE"] = "UPDATE";
})(Capabilities || (Capabilities = {}));
var Annotype;
(function (Annotype) {
    Annotype["CONNECT"] = "CONNECT";
    Annotype["RINGING"] = "RING";
})(Annotype || (Annotype = {}));
var CallPollActionType;
(function (CallPollActionType) {
    CallPollActionType["Accept"] = "accept";
    CallPollActionType["Forward"] = "forward";
    CallPollActionType["Reject"] = "reject";
})(CallPollActionType || (CallPollActionType = {}));
var CallStartActionType;
(function (CallStartActionType) {
    CallStartActionType[CallStartActionType["Abort"] = 0] = "Abort";
    CallStartActionType[CallStartActionType["Forward"] = 1] = "Forward";
    CallStartActionType[CallStartActionType["RejectMrf"] = 2] = "RejectMrf";
})(CallStartActionType || (CallStartActionType = {}));
var MediaOperationActionType;
(function (MediaOperationActionType) {
    MediaOperationActionType["PerformMediaOperation"] = "performMediaOperation";
})(MediaOperationActionType || (MediaOperationActionType = {}));
var MediaOperationContentType;
(function (MediaOperationContentType) {
    MediaOperationContentType["MSML"] = "application/msml+xml";
})(MediaOperationContentType || (MediaOperationContentType = {}));
;
;
function inputvalidation(session, event, localParams) {
    var log = session.log;
    try {
        if (session["s_SIPInvite"] != null) {
            if (session["s_SIPInvite"]["event-type"] !== null && (session["s_SIPInvite"]["event-type"] === "sip" || session["s_SIPInvite"]["event-type"] === "occp")) {
                if (session["s_SIPInvite"]["event-name"] !== null && session["s_SIPInvite"]["event-name"] === "sip.callStart.NONE")
                    log.debug("got sip invite");
                else
                    return "error.input.sipinviteincorrecteventname";
            }
            else {
                return "error.input.sipinviteincorrecteventtype";
            }
        }
        else {
            return "error.input.sipinvitemissing";
        }
        if ((event["action"] != null) && ((event["action"] === "promptandcollect") || (event["action"] === "playannouncement"))) {
            log.debug("action: {}", event["action"]);
            if (event["action"] === "promptandcollect")
                session["mrf"]["action"] = "promptandcollect";
            else if (event["action"] === "playannouncement")
                session["mrf"]["action"] = "playannouncement";
            else
                return "error.input.actionincorrect";
        }
        else {
            return "error.input.actionmissing";
        }
        if (event["earlydialog"] != null) {
            log.debug("earlydialog: {}", event["earlydialog"]);
            if (event["earlydialog"] === true) {
                session["mrf"]["earlydialog"] = true;
                return "true";
            }
            else if (event["earlydialog"] === false) {
                session["mrf"]["earlydialog"] = false;
                return "false";
            }
            else {
                return "error.input.earlydialogincorrect";
            }
        }
        else {
            return "error.input.earlydialog";
        }
    }
    catch (e) {
        log.debug("Log: {}", e);
        return "error.exception";
    }
}
function handle200OKINVITE(session, event, localParams) {
    var log = session.log;
    try {
        var eventData = localParams.message;
        session["mrf"]["headerrulevar=null"];
        session["mrf"]["headerrulesselect"] = null;
        session["mrf"]["ringingtones"] = null;
        var pollAction = void 0;
        pollAction = pollAction || {};
        pollAction.type = CallPollActionType.Accept;
        session["mrf"]["sendAction"] = JSON.stringify(pollAction);
        session["mrf"]["time200OKINVITE"] = Math.floor(new Date() / 1000);
        var to = eventData.SIP.To;
        if (to != null) {
            log.debug("received from MRF to tag:{}", to);
            session["mrf"]["callstate"] = "MRFCONNECTED200OK";
            session["mrf"]["downStreamToTag"] = to.tag;
            return "success";
        }
        else {
            log.debug("received from MRF no to tag:{}", to);
            return "error.nototag";
        }
    }
    catch (e) {
        log.debug("Log: {}", e);
        return "error.exception";
    }
}
function handle200OKINFO(session, event, localParams) {
    var log = session.log;
    try {
        var ret = { "dummy": 1, "event-name": "dummy", "event-type": "dummy", "session": session["fsm-id"] };
        session["mrf"]["callstate"] = "MRFCONNECTED";
        return ret;
    }
    catch (e) {
        log.debug("Log: {}", e);
        return "error.exception";
    }
}
function callAnswered(session, event, localParams) {
    var log = session.log;
    try {
        session["mrf"]["callstate"] = "ANSWERED";
        session["mrf"]["answertime"] = Math.floor(new Date() / 1000);
        return "success";
    }
    catch (e) {
        log.debug("Log: {}", e);
        return "error.exception";
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kdWxlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibW9kdWxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFVQSxJQUFLLFlBTUo7QUFORCxXQUFLLFlBQVk7SUFDZixpQ0FBaUIsQ0FBQTtJQUNqQixtQ0FBa0IsQ0FBQTtJQUNsQiw2Q0FBMkIsQ0FBQTtJQUMzQiwyQkFBUyxDQUFBO0lBQ1QsaUNBQWUsQ0FBQTtBQUNqQixDQUFDLEVBTkksWUFBWSxLQUFaLFlBQVksUUFNaEI7QUFzREQsSUFBSyxRQUdKO0FBSEQsV0FBSyxRQUFRO0lBQ1gsK0JBQW1CLENBQUE7SUFDbkIsNEJBQWdCLENBQUE7QUFDbEIsQ0FBQyxFQUhJLFFBQVEsS0FBUixRQUFRLFFBR1o7QUF1QkQsSUFBSyxrQkFJSjtBQUpELFdBQUssa0JBQWtCO0lBQ3RCLHVDQUFpQixDQUFBO0lBQ2pCLHlDQUFtQixDQUFBO0lBQ25CLHVDQUFpQixDQUFBO0FBQ2xCLENBQUMsRUFKSSxrQkFBa0IsS0FBbEIsa0JBQWtCLFFBSXRCO0FBRUQsSUFBSyxtQkFJSjtBQUpELFdBQUssbUJBQW1CO0lBQ3ZCLCtEQUFTLENBQUE7SUFDVCxtRUFBVyxDQUFBO0lBQ1gsdUVBQWEsQ0FBQTtBQUNkLENBQUMsRUFKSSxtQkFBbUIsS0FBbkIsbUJBQW1CLFFBSXZCO0FBZ0NELElBQUssd0JBRUo7QUFGRCxXQUFLLHdCQUF3QjtJQUM1QiwyRUFBK0MsQ0FBQTtBQUNoRCxDQUFDLEVBRkksd0JBQXdCLEtBQXhCLHdCQUF3QixRQUU1QjtBQUVELElBQUsseUJBRUo7QUFGRCxXQUFLLHlCQUF5QjtJQUM3QiwwREFBNkIsQ0FBQTtBQUM5QixDQUFDLEVBRkkseUJBQXlCLEtBQXpCLHlCQUF5QixRQUU3QjtBQW1GRCxDQUFDO0FBQ0QsQ0FBQztBQUNELFNBQVMsZUFBZSxDQUFDLE9BQWEsRUFBRSxLQUFXLEVBQUUsV0FBZ0I7SUFDakUsSUFBSSxHQUFHLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQztJQUV0QixJQUFJO1FBR0EsSUFBSyxPQUFPLENBQUMsYUFBYSxDQUFDLElBQUksSUFBSSxFQUFHO1lBQ2xDLElBQUksT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDLFlBQVksQ0FBQyxLQUFHLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQyxZQUFZLENBQUMsS0FBRyxLQUFLLElBQUksT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDLFlBQVksQ0FBQyxLQUFHLE1BQU0sQ0FBQyxFQUFFO2dCQUNoSixJQUFJLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQyxZQUFZLENBQUMsS0FBRyxJQUFJLElBQUksT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDLFlBQVksQ0FBQyxLQUFLLG9CQUFvQjtvQkFDNUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDOztvQkFFNUIsT0FBTyx5Q0FBeUMsQ0FBQzthQUN4RDtpQkFBTTtnQkFDSCxPQUFPLHlDQUF5QyxDQUFDO2FBQ3BEO1NBQ0o7YUFBTTtZQUNILE9BQU8sOEJBQThCLENBQUM7U0FDekM7UUFHRCxJQUFLLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLEtBQUcsa0JBQWtCLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsS0FBRyxrQkFBa0IsQ0FBQyxDQUFDLEVBQUc7WUFDbkgsR0FBRyxDQUFDLEtBQUssQ0FBQyxZQUFZLEVBQUUsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7WUFDekMsSUFBSyxLQUFLLENBQUMsUUFBUSxDQUFDLEtBQUcsa0JBQWtCO2dCQUNyQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsUUFBUSxDQUFDLEdBQUcsa0JBQWtCLENBQUM7aUJBQzdDLElBQUssS0FBSyxDQUFDLFFBQVEsQ0FBQyxLQUFHLGtCQUFrQjtnQkFDMUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLFFBQVEsQ0FBQyxHQUFHLGtCQUFrQixDQUFDOztnQkFFOUMsT0FBTyw2QkFBNkIsQ0FBQztTQUM1QzthQUFNO1lBQ0gsT0FBTywyQkFBMkIsQ0FBQztTQUN0QztRQUdELElBQUssS0FBSyxDQUFDLGFBQWEsQ0FBQyxJQUFJLElBQUksRUFBRztZQUNoQyxHQUFHLENBQUMsS0FBSyxDQUFDLGlCQUFpQixFQUFFLEtBQUssQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO1lBQ25ELElBQUssS0FBSyxDQUFDLGFBQWEsQ0FBQyxLQUFLLElBQUksRUFBRTtnQkFDaEMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLGFBQWEsQ0FBQyxHQUFHLElBQUksQ0FBQztnQkFDckMsT0FBTyxNQUFNLENBQUM7YUFDakI7aUJBQU0sSUFBSyxLQUFLLENBQUMsYUFBYSxDQUFDLEtBQUssS0FBSyxFQUFFO2dCQUN4QyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsYUFBYSxDQUFDLEdBQUcsS0FBSyxDQUFDO2dCQUN0QyxPQUFPLE9BQU8sQ0FBQzthQUNsQjtpQkFBTTtnQkFDSCxPQUFPLGtDQUFrQyxDQUFDO2FBQzdDO1NBQ0o7YUFBTTtZQUNILE9BQU8seUJBQXlCLENBQUM7U0FDcEM7S0FDSjtJQUFDLE9BQU8sQ0FBQyxFQUFFO1FBQ1IsR0FBRyxDQUFDLEtBQUssQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDeEIsT0FBTyxpQkFBaUIsQ0FBQztLQUM1QjtBQUNMLENBQUM7QUFFRCxTQUFTLGlCQUFpQixDQUFDLE9BQVcsRUFBQyxLQUF1QixFQUFDLFdBQWU7SUFDMUUsSUFBSSxHQUFHLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQztJQUV0QixJQUFJO1FBRUEsSUFBSSxTQUFTLEdBQUcsV0FBVyxDQUFDLE9BQU8sQ0FBQztRQUVwQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsb0JBQW9CLENBQUMsQ0FBQztRQUNyQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsbUJBQW1CLENBQUMsR0FBRyxJQUFJLENBQUM7UUFDM0MsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLGNBQWMsQ0FBQyxHQUFHLElBQUksQ0FBQztRQUV0QyxJQUFJLFVBQVUsU0FBaUIsQ0FBQztRQUNoQyxVQUFVLEdBQUcsVUFBVSxJQUFJLEVBQUUsQ0FBQztRQUM5QixVQUFVLENBQUMsSUFBSSxHQUFHLGtCQUFrQixDQUFDLE1BQU0sQ0FBQztRQUM1QyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsWUFBWSxDQUFDLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUUxRCxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsaUJBQWlCLENBQUMsR0FBSSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksSUFBSSxFQUFFLEdBQUMsSUFBSSxDQUFDLENBQUM7UUFHakUsSUFBSSxFQUFFLEdBQVEsU0FBUyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUM7UUFDL0IsSUFBSSxFQUFFLElBQUUsSUFBSSxFQUFFO1lBQ1YsR0FBRyxDQUFDLEtBQUssQ0FBQyw2QkFBNkIsRUFBQyxFQUFFLENBQUMsQ0FBQztZQUM1QyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsV0FBVyxDQUFDLEdBQUksbUJBQW1CLENBQUM7WUFDbkQsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLGlCQUFpQixDQUFDLEdBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQztZQUN6QyxPQUFPLFNBQVMsQ0FBQztTQUNwQjthQUFNO1lBQ0gsR0FBRyxDQUFDLEtBQUssQ0FBQyxnQ0FBZ0MsRUFBQyxFQUFFLENBQUMsQ0FBQztZQUMvQyxPQUFPLGVBQWUsQ0FBQztTQUMxQjtLQUVKO0lBQUMsT0FBTyxDQUFDLEVBQUU7UUFDUixHQUFHLENBQUMsS0FBSyxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUN4QixPQUFPLGlCQUFpQixDQUFDO0tBQzVCO0FBQ0wsQ0FBQztBQUVELFNBQVMsZUFBZSxDQUFDLE9BQWEsRUFBRSxLQUFXLEVBQUUsV0FBZ0I7SUFDakUsSUFBSSxHQUFHLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQztJQUV0QixJQUFJO1FBQ0EsSUFBSSxHQUFHLEdBQVEsRUFBQyxPQUFPLEVBQUMsQ0FBQyxFQUFDLFlBQVksRUFBQyxPQUFPLEVBQUMsWUFBWSxFQUFDLE9BQU8sRUFBQyxTQUFTLEVBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxFQUFDLENBQUM7UUFDakcsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLFdBQVcsQ0FBQyxHQUFJLGNBQWMsQ0FBQztRQUM5QyxPQUFPLEdBQUcsQ0FBQztLQUNkO0lBQUMsT0FBTyxDQUFDLEVBQUU7UUFDUixHQUFHLENBQUMsS0FBSyxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUN4QixPQUFPLGlCQUFpQixDQUFDO0tBQzVCO0FBQ0wsQ0FBQztBQUVELFNBQVMsWUFBWSxDQUFDLE9BQWEsRUFBRSxLQUFXLEVBQUUsV0FBZ0I7SUFDOUQsSUFBSSxHQUFHLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQztJQUV0QixJQUFJO1FBQ0EsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLFdBQVcsQ0FBQyxHQUFJLFVBQVUsQ0FBQztRQUMxQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsWUFBWSxDQUFDLEdBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLElBQUksRUFBRSxHQUFDLElBQUksQ0FBQyxDQUFDO1FBQzVELE9BQU8sU0FBUyxDQUFDO0tBQ3BCO0lBQUMsT0FBTyxDQUFDLEVBQUU7UUFDUixHQUFHLENBQUMsS0FBSyxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUN4QixPQUFPLGlCQUFpQixDQUFDO0tBQzVCO0FBQ0wsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vaW50ZXJmYWNlIGRlZmluaXRpb25cblxuaW50ZXJmYWNlIExlZyB7XG4gIGFkZHJlc3MgOiBzdHJpbmc7XG4gIG5hbWUgOiBzdHJpbmdcbn1cbmludGVyZmFjZSBDYWxsIHtcbiAgc3RhdGUgOiBudW1iZXJcbn1cblxuZW51bSBDYXBhYmlsaXRpZXMge1xuICBSRUwxWFggPSBcIlJFTDFYWFwiLFxuICBGT1JLSU5HPSBcIkZPUktJTkdcIixcbiAgUFJFQ09ORElUSU9OPVwiUFJFQ09ORElUSU9OXCIsXG4gIFBFTT1cIlBFTVwiLFxuICBVUERBVEU9XCJVUERBVEVcIlxufVxuXG5pbnRlcmZhY2UgTWVzc2FnZSB7XG4gIG1ldGhvZCA6IFtzdHJpbmddO1xuICB0eXBlIDogW3N0cmluZ107XG4gIGJvZHkgOiBbc3RyaW5nXVxufVxuXG5pbnRlcmZhY2UgU0lQIHtcbiAgY2FwYWJpbGl0aWVzIDogW0NhcGFiaWxpdGllc107XG4gIG1lc3NhZ2UgOiBNZXNzYWdlXG59XG5cbmludGVyZmFjZSBDYWxsU3RhcnQge1xuICBjb250YWN0IDogc3RyaW5nO1xuICBjYXVzZTogc3RyaW5nO1xuICBsZWcgOiBzdHJpbmdcbn1cblxuaW50ZXJmYWNlIENhbGxQb2xsIHtcbiAgbmFtZTogc3RyaW5nO1xuICB0eXBlOiBzdHJpbmc7XG4gIGxlZzogc3RyaW5nXG59XG5cbmludGVyZmFjZSBFdmVudCB7XG4gIG5hbWUgOiBzdHJpbmc7XG4gIGNhbGxTdGFydD8gOiBDYWxsU3RhcnQ7XG4gIGNhbGxQb2xsPyA6IENhbGxQb2xsXG59XG5cblxuaW50ZXJmYWNlIE9DQ1BFdmVudCB7XG4gIGNhbGxpZCA6IHN0cmluZztcbiAgY2FsbCA6IENhbGw7XG4gIGFzIDogc3RyaW5nO1xuICBldmVudHRpbWUgOiBudW1iZXI7XG4gIFNJUCA6IFNJUDtcbiAgZXZlbnQ6IEV2ZW50XG59XG5cbmludGVyZmFjZSBFdmVudHMge1xuICBTdWNjZXNzUmVzcG9uc2VQb2xsRXZlbnQ/IDogc3RyaW5nO1xuICBSYXdDb250ZW50UG9sbEV2ZW50PyA6IHN0cmluZztcbiAgSW5mb1BvbGxFdmVudD86IHN0cmluZ1xufVxuLyoqXG4gIERlZmluZSBoZWFkZXIgdmFyaWFibGVzIHVzZWQgYnkgYXBwbGljYXRpb25cbiovXG5pbnRlcmZhY2UgSGVhZGVyVmFycyB7XG4gIGRpc2FibGVTZW5kRGVmYXVsdFJlYXNvbj8gOiBzdHJpbmc7XG4gIGRpc2FibGVTZW5kTm9BbnN3ZXJSZWFzb24/IDogc3RyaW5nXG59XG5cbmVudW0gQW5ub3R5cGUge1xuICBDT05ORUNUID0gXCJDT05ORUNUXCIsXG4gIFJJTkdJTkcgPSBcIlJJTkdcIlxufVxuXG5pbnRlcmZhY2UgUmluZ2luZ1RvbmUge1xuICBhbm5vX25hbWUgOiBzdHJpbmc7XG4gIGFubm9fdHlwZSA6IEFubm90eXBlXG59XG5cbmludGVyZmFjZSBTZXNzaW9uIHtcbiAgbG9nIDogYW55O1xuICBpbkNhcGFiaWxpdGllcyA6IFtDYXBhYmlsaXRpZXNdO1xuICBvdXRDYXBhYmlsaXRpZXM/IDogc3RyaW5nO1xuICBldmVudHM/IDogc3RyaW5nO1xuICBoZWFkZXJydWxldmFyPyA6IHN0cmluZztcbiAgaGVhZGVycnVsZXNzZWxlY3Q/IDogc3RyaW5nO1xuICByaW5naW5ndG9uZXM/IDogc3RyaW5nO1xuICBzZW5kQWN0aW9uPyA6IHN0cmluZyA7XG4gIFNJUEhlbHBlciA6IGFueTtcbiAgU0lQSW5pdGlhbEludml0ZT8gOiBhbnk7XG4gIFNJUE1lc3NhZ2U/IDogYW55O1xuICBTSVBNZXNzYWdlVHlwZT8gOiBhbnlcbn1cblxuXG5lbnVtIENhbGxQb2xsQWN0aW9uVHlwZSB7XG4gQWNjZXB0ID0gXCJhY2NlcHRcIixcbiBGb3J3YXJkID0gXCJmb3J3YXJkXCIsXG4gUmVqZWN0ID0gXCJyZWplY3RcIixcbn1cblxuZW51bSBDYWxsU3RhcnRBY3Rpb25UeXBlIHtcbiBBYm9ydCA9IDAsXG4gRm9yd2FyZCA9IDEsXG4gUmVqZWN0TXJmID0gMlxufVxuXG5cblxuLyoqXG4gU2V0IGFjdGlvbiBmb3IgQ2FsbFN0YXJ0IGV2ZW50XG4qL1xuaW50ZXJmYWNlIENhbGxTdGFydEFjdGlvbiB7XG4gdHlwZSA6IENhbGxTdGFydEFjdGlvblR5cGU7XG4gZXJyb3Jjb2RlIDogbnVtYmVyO1xuIGNhdXNlIDogc3RyaW5nIDtcbiB1cmkgOiBzdHJpbmc7XG4gZWFybHltZWRpYSA6IG51bWJlcjtcbiBsZWduYW1lIDogc3RyaW5nIFxufVxuXG4vKipcbiBTZXQgYWN0aW9uIGZvciBDYWxsUG9sbCBldmVudFxuKi9cbmludGVyZmFjZSBDYWxsUG9sbEFjdGlvbiB7XG4gdHlwZSA6IENhbGxQb2xsQWN0aW9uVHlwZVxufVxuXG5cbi8qKlxuIEFwcGxpY2F0aW9uIGNhbiBzZXQgYWN0aW9uIGZvciBhIHNwZWNpZmljIGxlZywgdGhpcyBpcyBhcHBsaWNhYmxlIGZvciBNUkYgY29udGFjdFxuICovXG5pbnRlcmZhY2UgTGVnQWN0aW9uIHtcbiB0eXBlIDogQ2FsbFN0YXJ0QWN0aW9uVHlwZSA7XG4gbGVnYWN0aW9uIDogc3RyaW5nXG59XG5cbmVudW0gTWVkaWFPcGVyYXRpb25BY3Rpb25UeXBlIHtcbiBQZXJmb3JtTWVkaWFPcGVyYXRpb24gPSBcInBlcmZvcm1NZWRpYU9wZXJhdGlvblwiXG59XG5cbmVudW0gTWVkaWFPcGVyYXRpb25Db250ZW50VHlwZSB7XG4gTVNNTCA9IFwiYXBwbGljYXRpb24vbXNtbCt4bWxcIlxufVxuXG5pbnRlcmZhY2UgUGVyZm9ybU1lZGlhT3BlcmF0aW9uIHtcbiBDb250ZW50VHlwZSA6IE1lZGlhT3BlcmF0aW9uQ29udGVudFR5cGU7XG4gQ29udGVudCA6IHN0cmluZ1xufVxuXG5pbnRlcmZhY2UgTWVkaWFPcGVyYXRpb25BY3Rpb24ge1xuIHR5cGUgOiBudW1iZXI7XG4gbGVnYWN0aW9uIDogTWVkaWFPcGVyYXRpb25BY3Rpb25UeXBlO1xuIHBlcmZvcm1NZWRpYU9wZXJhdGlvbiA6IFBlcmZvcm1NZWRpYU9wZXJhdGlvblxufVxuXG5pbnRlcmZhY2UgQWN0aW9uIHtcbiBhY3Rpb24gOiBhbnkgXG59XG5cblxuaW50ZXJmYWNlIEhlYWRlciB7XG4gaGVhZGVyIDogc3RyaW5nO1xuIHZhbHVlIDogc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgUUhlYWRlciB7XG4gUHJpdmFjeSA6IHN0cmluZztcbiBSZWFzb24gOiBzdHJpbmcgO1xufVxuXG5pbnRlcmZhY2UgUGFyYW1ldGVyIHtcbiB0cmFuc3BvcnQgOiBzdHJpbmc7XG4gdXNlciA6IHN0cmluZyA7XG59XG5cbmludGVyZmFjZSBVUkkge1xuIHNjaGVtZSA6IHN0cmluZztcbiBhdXRob3JpdHkgOiBzdHJpbmcgO1xuIGdyIDogc3RyaW5nIDtcbiBob3N0OiBzdHJpbmcgO1xuIGxyIDogc3RyaW5nIDtcbiBtYWRkciA6IHN0cmluZyA7XG4gcG9ydCA6IG51bWJlciAgO1xuIHVzZXIgOiBzdHJpbmcgO1xuIHBhcmFtZXRlcnMgOiBbUGFyYW1ldGVyXTtcbiBxaGVhZGVyIDogW1FIZWFkZXJdO1xufVxuXG5pbnRlcmZhY2UgQWRkcmVzcyB7XG4gZGlzcGxheU5hbWUgOiBzdHJpbmc7XG4gdXJpIDogVVJJIFxufVxuXG5pbnRlcmZhY2UgSGlzdG9yeUluZm8gaW1wbGVtZW50cyBIZWFkZXIge1xuIGFkZHJlc3MgOiBBZGRyZXNzO1xuIGluZGV4IDogc3RyaW5nXG59XG5cbmludGVyZmFjZSBQQUkgaW1wbGVtZW50cyBIZWFkZXIgIHtcbiBhZGRyZXNzIDogQWRkcmVzc1xufVxuXG5pbnRlcmZhY2UgRnJvbSBpbXBsZW1lbnRzIEhlYWRlciB7XG4gYWRkcmVzcyA6IEFkZHJlc3M7XG4gdGFnIDogc3RyaW5nIDtcbn1cblxuaW50ZXJmYWNlIFRvIGltcGxlbWVudHMgSGVhZGVyIHtcbiBhZGRyZXNzIDogQWRkcmVzcztcbiB0YWcgOiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBQQ1YgaW1wbGVtZW50cyBIZWFkZXIge1xuIGljaWRfZ2VuZXJhdGVkX2F0OiBzdHJpbmcgO1xuIGljaWRfdmFsdWUgOiBzdHJpbmcgO1xuIG9haWQgOiBzdHJpbmc7XG4gdGFpZCA6IHN0cmluZztcbiBvc2lkIDogc3RyaW5nO1xuIHRzaWQgOiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBSZXN1bHRDb2RlIHtcbiAgcmVzdWx0Q29kZSA6IHN0cmluZyA7XG59XG5cbjsvL01BSU5CTE9DS1xuO1xyXG5mdW5jdGlvbiBpbnB1dHZhbGlkYXRpb24oc2Vzc2lvbiA6IGFueSwgZXZlbnQgOiBhbnksIGxvY2FsUGFyYW1zOiBhbnkgKXtcclxuICAgIGxldCBsb2cgPSBzZXNzaW9uLmxvZztcclxuXHJcbiAgICB0cnkge1xyXG5cclxuICAgICAgICAvL3NpcCBpbnZpdGUgaXMgaW4gI3Nlc3Npb25bXCJzX1NJUEludml0ZVwiXVxyXG4gICAgICAgIGlmICggc2Vzc2lvbltcInNfU0lQSW52aXRlXCJdICE9IG51bGwgKSB7XHJcbiAgICAgICAgICAgIGlmKCBzZXNzaW9uW1wic19TSVBJbnZpdGVcIl1bXCJldmVudC10eXBlXCJdIT09bnVsbCAmJiAoc2Vzc2lvbltcInNfU0lQSW52aXRlXCJdW1wiZXZlbnQtdHlwZVwiXT09PVwic2lwXCIgfHwgc2Vzc2lvbltcInNfU0lQSW52aXRlXCJdW1wiZXZlbnQtdHlwZVwiXT09PVwib2NjcFwiKSkge1xyXG4gICAgICAgICAgICAgICAgaWYoIHNlc3Npb25bXCJzX1NJUEludml0ZVwiXVtcImV2ZW50LW5hbWVcIl0hPT1udWxsICYmIHNlc3Npb25bXCJzX1NJUEludml0ZVwiXVtcImV2ZW50LW5hbWVcIl0gPT09IFwic2lwLmNhbGxTdGFydC5OT05FXCIpXHJcbiAgICAgICAgICAgICAgICAgICAgbG9nLmRlYnVnKFwiZ290IHNpcCBpbnZpdGVcIik7XHJcbiAgICAgICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFwiZXJyb3IuaW5wdXQuc2lwaW52aXRlaW5jb3JyZWN0ZXZlbnRuYW1lXCI7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gXCJlcnJvci5pbnB1dC5zaXBpbnZpdGVpbmNvcnJlY3RldmVudHR5cGVcIjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBcImVycm9yLmlucHV0LnNpcGludml0ZW1pc3NpbmdcIjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vcHJvbXB0YW5kY29sbGVjdCwgcGxheWFubm91bmNlbWVudFxyXG4gICAgICAgIGlmICggKGV2ZW50W1wiYWN0aW9uXCJdICE9IG51bGwpICYmICgoZXZlbnRbXCJhY3Rpb25cIl09PT1cInByb21wdGFuZGNvbGxlY3RcIikgfHwgKGV2ZW50W1wiYWN0aW9uXCJdPT09XCJwbGF5YW5ub3VuY2VtZW50XCIpKSApIHtcclxuICAgICAgICAgICAgbG9nLmRlYnVnKFwiYWN0aW9uOiB7fVwiLCBldmVudFtcImFjdGlvblwiXSk7XHJcbiAgICAgICAgICAgIGlmICggZXZlbnRbXCJhY3Rpb25cIl09PT1cInByb21wdGFuZGNvbGxlY3RcIiApIFxyXG4gICAgICAgICAgICAgICAgc2Vzc2lvbltcIm1yZlwiXVtcImFjdGlvblwiXSA9IFwicHJvbXB0YW5kY29sbGVjdFwiO1xyXG4gICAgICAgICAgICBlbHNlIGlmICggZXZlbnRbXCJhY3Rpb25cIl09PT1cInBsYXlhbm5vdW5jZW1lbnRcIiApIFxyXG4gICAgICAgICAgICAgICAgc2Vzc2lvbltcIm1yZlwiXVtcImFjdGlvblwiXSA9IFwicGxheWFubm91bmNlbWVudFwiO1xyXG4gICAgICAgICAgICBlbHNlXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gXCJlcnJvci5pbnB1dC5hY3Rpb25pbmNvcnJlY3RcIjsgICAgICAgICAgICBcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gXCJlcnJvci5pbnB1dC5hY3Rpb25taXNzaW5nXCI7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvL2Vhcmx5IGRpYWxvZyBpcyBib29sZWFuIHRydWUvZmFsc2VcclxuICAgICAgICBpZiAoIGV2ZW50W1wiZWFybHlkaWFsb2dcIl0gIT0gbnVsbCApIHtcclxuICAgICAgICAgICAgbG9nLmRlYnVnKFwiZWFybHlkaWFsb2c6IHt9XCIsIGV2ZW50W1wiZWFybHlkaWFsb2dcIl0pO1xyXG4gICAgICAgICAgICBpZiAoIGV2ZW50W1wiZWFybHlkaWFsb2dcIl0gPT09IHRydWUpIHtcclxuICAgICAgICAgICAgICAgIHNlc3Npb25bXCJtcmZcIl1bXCJlYXJseWRpYWxvZ1wiXSA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gXCJ0cnVlXCI7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoIGV2ZW50W1wiZWFybHlkaWFsb2dcIl0gPT09IGZhbHNlKSB7XHJcbiAgICAgICAgICAgICAgICBzZXNzaW9uW1wibXJmXCJdW1wiZWFybHlkaWFsb2dcIl0gPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBcImZhbHNlXCI7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gXCJlcnJvci5pbnB1dC5lYXJseWRpYWxvZ2luY29ycmVjdFwiO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIFwiZXJyb3IuaW5wdXQuZWFybHlkaWFsb2dcIjtcclxuICAgICAgICB9XHJcbiAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgbG9nLmRlYnVnKFwiTG9nOiB7fVwiLCBlKTtcclxuICAgICAgICByZXR1cm4gXCJlcnJvci5leGNlcHRpb25cIjtcclxuICAgIH1cclxufVxyXG5cclxuZnVuY3Rpb24gaGFuZGxlMjAwT0tJTlZJVEUoc2Vzc2lvbjphbnksZXZlbnQ6T0NDUFNJUC5PQ0NQRXZlbnQsbG9jYWxQYXJhbXM6YW55KSB7XHJcbiAgICBsZXQgbG9nID0gc2Vzc2lvbi5sb2c7XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgICAvL3RoZSByZWNlaXZlZCBldmVudCBpcyBub3cgaW4gbG9jYWxQYXJhbXNcclxuICAgICAgICBsZXQgZXZlbnREYXRhID0gbG9jYWxQYXJhbXMubWVzc2FnZTtcclxuICAgICAgICAvL3Nlc3Npb24uZXZlbnRzID0gbnVsbDtcclxuICAgICAgICBzZXNzaW9uW1wibXJmXCJdW1wiaGVhZGVycnVsZXZhcj1udWxsXCJdO1xyXG4gICAgICAgIHNlc3Npb25bXCJtcmZcIl1bXCJoZWFkZXJydWxlc3NlbGVjdFwiXSA9IG51bGw7XHJcbiAgICAgICAgc2Vzc2lvbltcIm1yZlwiXVtcInJpbmdpbmd0b25lc1wiXSA9IG51bGw7XHJcblxyXG4gICAgICAgIGxldCBwb2xsQWN0aW9uIDogQ2FsbFBvbGxBY3Rpb247XHJcbiAgICAgICAgcG9sbEFjdGlvbiA9IHBvbGxBY3Rpb24gfHwge307XHJcbiAgICAgICAgcG9sbEFjdGlvbi50eXBlID0gQ2FsbFBvbGxBY3Rpb25UeXBlLkFjY2VwdDtcclxuICAgICAgICBzZXNzaW9uW1wibXJmXCJdW1wic2VuZEFjdGlvblwiXSA9IEpTT04uc3RyaW5naWZ5KHBvbGxBY3Rpb24pO1xyXG5cclxuICAgICAgICBzZXNzaW9uW1wibXJmXCJdW1widGltZTIwME9LSU5WSVRFXCJdICA9IE1hdGguZmxvb3IobmV3IERhdGUoKS8xMDAwKTtcclxuXHJcbiAgICAgICAgLy9zYXZlIHRvIHRhZ1xyXG4gICAgICAgIGxldCB0byA6IFRvID0gZXZlbnREYXRhLlNJUC5UbztcclxuICAgICAgICBpZiggdG8hPW51bGwpIHtcclxuICAgICAgICAgICAgbG9nLmRlYnVnKFwicmVjZWl2ZWQgZnJvbSBNUkYgdG8gdGFnOnt9XCIsdG8pO1xyXG4gICAgICAgICAgICBzZXNzaW9uW1wibXJmXCJdW1wiY2FsbHN0YXRlXCJdICA9IFwiTVJGQ09OTkVDVEVEMjAwT0tcIjtcclxuICAgICAgICAgICAgc2Vzc2lvbltcIm1yZlwiXVtcImRvd25TdHJlYW1Ub1RhZ1wiXT10by50YWc7XHJcbiAgICAgICAgICAgIHJldHVybiBcInN1Y2Nlc3NcIjtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBsb2cuZGVidWcoXCJyZWNlaXZlZCBmcm9tIE1SRiBubyB0byB0YWc6e31cIix0byk7XHJcbiAgICAgICAgICAgIHJldHVybiBcImVycm9yLm5vdG90YWdcIjtcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgbG9nLmRlYnVnKFwiTG9nOiB7fVwiLCBlKTtcclxuICAgICAgICByZXR1cm4gXCJlcnJvci5leGNlcHRpb25cIjtcclxuICAgIH1cclxufVxyXG5cclxuZnVuY3Rpb24gaGFuZGxlMjAwT0tJTkZPKHNlc3Npb24gOiBhbnksIGV2ZW50IDogYW55LCBsb2NhbFBhcmFtczogYW55ICl7XHJcbiAgICBsZXQgbG9nID0gc2Vzc2lvbi5sb2c7XHJcblxyXG4gICAgdHJ5IHtcclxuICAgICAgICBsZXQgcmV0OiBhbnkgPSB7XCJkdW1teVwiOjEsXCJldmVudC1uYW1lXCI6XCJkdW1teVwiLFwiZXZlbnQtdHlwZVwiOlwiZHVtbXlcIixcInNlc3Npb25cIjpzZXNzaW9uW1wiZnNtLWlkXCJdfTtcclxuICAgICAgICBzZXNzaW9uW1wibXJmXCJdW1wiY2FsbHN0YXRlXCJdICA9IFwiTVJGQ09OTkVDVEVEXCI7XHJcbiAgICAgICAgcmV0dXJuIHJldDtcclxuICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICBsb2cuZGVidWcoXCJMb2c6IHt9XCIsIGUpO1xyXG4gICAgICAgIHJldHVybiBcImVycm9yLmV4Y2VwdGlvblwiO1xyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBjYWxsQW5zd2VyZWQoc2Vzc2lvbiA6IGFueSwgZXZlbnQgOiBhbnksIGxvY2FsUGFyYW1zOiBhbnkgKXtcclxuICAgIGxldCBsb2cgPSBzZXNzaW9uLmxvZztcclxuXHJcbiAgICB0cnkgeyAgICAgICAgXHJcbiAgICAgICAgc2Vzc2lvbltcIm1yZlwiXVtcImNhbGxzdGF0ZVwiXSAgPSBcIkFOU1dFUkVEXCI7XHJcbiAgICAgICAgc2Vzc2lvbltcIm1yZlwiXVtcImFuc3dlcnRpbWVcIl0gID0gTWF0aC5mbG9vcihuZXcgRGF0ZSgpLzEwMDApO1xyXG4gICAgICAgIHJldHVybiBcInN1Y2Nlc3NcIjtcclxuICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICBsb2cuZGVidWcoXCJMb2c6IHt9XCIsIGUpO1xyXG4gICAgICAgIHJldHVybiBcImVycm9yLmV4Y2VwdGlvblwiO1xyXG4gICAgfVxyXG59XHJcblxyXG5cclxuXHJcblxyXG4iXX0=