"use strict";
var Capabilities;
(function (Capabilities) {
    Capabilities["REL1XX"] = "REL1XX";
    Capabilities["FORKING"] = "FORKING";
    Capabilities["PRECONDITION"] = "PRECONDITION";
    Capabilities["PEM"] = "PEM";
    Capabilities["UPDATE"] = "UPDATE";
})(Capabilities || (Capabilities = {}));
var Annotype;
(function (Annotype) {
    Annotype["CONNECT"] = "CONNECT";
    Annotype["RINGING"] = "RING";
})(Annotype || (Annotype = {}));
var CallPollActionType;
(function (CallPollActionType) {
    CallPollActionType["Accept"] = "accept";
    CallPollActionType["Forward"] = "forward";
    CallPollActionType["Reject"] = "reject";
})(CallPollActionType || (CallPollActionType = {}));
var CallStartActionType;
(function (CallStartActionType) {
    CallStartActionType[CallStartActionType["Abort"] = 0] = "Abort";
    CallStartActionType[CallStartActionType["Forward"] = 1] = "Forward";
    CallStartActionType[CallStartActionType["RejectMrf"] = 2] = "RejectMrf";
})(CallStartActionType || (CallStartActionType = {}));
var MediaOperationActionType;
(function (MediaOperationActionType) {
    MediaOperationActionType["PerformMediaOperation"] = "performMediaOperation";
})(MediaOperationActionType || (MediaOperationActionType = {}));
var MediaOperationContentType;
(function (MediaOperationContentType) {
    MediaOperationContentType["MSML"] = "application/msml+xml";
})(MediaOperationContentType || (MediaOperationContentType = {}));
;
;
function inputvalidation(session, event, localParams) {
    var log = session.log;
    try {
        if (session["s_SIPInvite"] != null) {
            if (session["s_SIPInvite"]["event-type"] !== null && (session["s_SIPInvite"]["event-type"] === "sip" || session["s_SIPInvite"]["event-type"] === "occp")) {
                if (session["s_SIPInvite"]["event-name"] !== null && session["s_SIPInvite"]["event-name"] === "sip.callStart.NONE")
                    log.debug("got sip invite");
                else
                    return "error.input.sipinviteincorrecteventname";
            }
            else {
                return "error.input.sipinviteincorrecteventtype";
            }
        }
        else {
            return "error.input.sipinvitemissing";
        }
        return "true";
        if (event["announcement"] != null) {
            log.debug("announcement: {}", event["announcement"]);
            session["mrf"]["announcement"] = event["announcement"];
        }
        else {
            return "error.input.actionmissing";
        }
        if ((event["action"] != null) && ((event["action"] === "promptandcollect") || (event["action"] === "playannouncement"))) {
            log.debug("action: {}", event["action"]);
            if (event["action"] === "promptandcollect")
                session["mrf"]["action"] = "promptandcollect";
            else if (event["action"] === "playannouncement")
                session["mrf"]["action"] = "playannouncement";
            else
                return "error.input.actionincorrect";
        }
        else {
            return "error.input.actionmissing";
        }
        if (event["earlydialog"] != null) {
            log.debug("earlydialog: {}", event["earlydialog"]);
            if (event["earlydialog"] === true) {
                session["mrf"]["earlydialog"] = true;
                return "true";
            }
            else if (event["earlydialog"] === false) {
                session["mrf"]["earlydialog"] = false;
                return "false";
            }
            else {
                return "error.input.earlydialogincorrect";
            }
        }
        else {
            return "error.input.earlydialog";
        }
    }
    catch (e) {
        log.debug("Log: {}", e);
        return "error.exception";
    }
}
function armMRFevents(sessionData, eventData, localParams) {
    var ret;
    var status2;
    var events;
    events = events || {};
    events.InfoPollEvent = "null";
    events.SuccessResponsePollEvent = "null";
    events.RawContentPollEvent = "test/test";
    var headerVars;
    headerVars = headerVars || {};
    headerVars.disableSendDefaultReason = "Disabled";
    headerVars.disableSendNoAnswerReason = "Disabled";
    var ringingTones;
    ringingTones = ringingTones || [];
    var comf;
    comf = comf || {};
    comf.anno_name = "comfort";
    comf.anno_type = Annotype.CONNECT;
    var ring;
    ring = ring || {};
    ring.anno_name = "ringing";
    ring.anno_type = Annotype.RINGING;
    ringingTones.push(comf, ring);
    var capabilities = sessionData.inCapabilities;
    if (capabilities != null) {
        capabilities.push(Capabilities.PEM);
        capabilities.push(Capabilities.FORKING);
        sessionData.outCapabilities = JSON.stringify(capabilities);
    }
    sessionData.events = JSON.stringify(events);
    sessionData.headerrulevar = JSON.stringify(headerVars);
    sessionData.headerrulesselect = "SipServiceSpecificRulesSet";
    sessionData.ringingtones = JSON.stringify(ringingTones);
    sessionData.upstreamCapabilities = JSON.stringify([]);
    return "success";
}
function handle200OKINVITE(session, event, localParams) {
    var log = session.log;
    try {
        var eventData = localParams.message;
        session["mrf"]["headerrulevar=null"];
        session["mrf"]["headerrulesselect"] = null;
        session["mrf"]["ringingtones"] = null;
        var pollAction = void 0;
        pollAction = pollAction || {};
        pollAction.type = CallPollActionType.Accept;
        session["mrf"]["sendAction"] = JSON.stringify(pollAction);
        session["mrf"]["time200OKINVITE"] = Math.floor(new Date() / 1000);
        var to = eventData.SIP.To;
        if (to != null) {
            log.debug("received from MRF to tag:{}", to);
            session["mrf"]["callstate"] = "MRFCONNECTED200OK";
            session["mrf"]["downStreamToTag"] = to.tag;
            return "success";
        }
        else {
            log.debug("received from MRF no to tag:{}", to);
            return "error.nototag";
        }
    }
    catch (e) {
        log.debug("handle200OKINVITE Log: {}", e);
        return "error.exception";
    }
}
function handle200OKINFO(session, event, localParams) {
    var log = session.log;
    try {
        session["mrf"]["time200OKINFO"] = Math.floor(new Date() / 1000);
        session["mrf"]["callstate"] = "MRFCONNECTED";
        if (event.SIP.content.json.msml.event.name[2] != null) {
            if (event.SIP.content.json.msml.event.name[2] == "dtmf.digits") {
                log.debug("Got DTMF digits;");
                if (event.SIP.content.json.msml.event.value[1] != null) {
                    session["mrf"]["dtmfdigit"] = event.SIP.content.json.msml.event.value[1];
                }
                else {
                    session["mrf"]["dtmfdigit"] = "0";
                }
            }
            else {
                log.debug("No DTMF digits;");
            }
        }
    }
    catch (e) {
        log.debug("Log: {}", e);
        return "error.exception";
    }
    return session["mrf"]["dtmfdigit"];
}
function callAnswered(session, event, localParams) {
    var log = session.log;
    try {
        session["mrf"]["callstate"] = "ANSWERED";
        session["mrf"]["answertime"] = Math.floor(new Date() / 1000);
        return "success";
    }
    catch (e) {
        log.debug("Log: {}", e);
        return "error.exception";
    }
}
function checkDisconnectReason(session, event, localParams) {
    var log = session.log;
    try {
        session["mrf"]["callstate"] = "ConnectError";
        session["mrf"]["connecterrortime"] = Math.floor(new Date() / 1000);
        var eventsStack = event['events-stack'];
        if (eventsStack != null && eventsStack.size() > 0) {
            for (var i = eventsStack.size() - 1; i >= 0; i--) {
                if (eventsStack.get(i).equals("leg.timeout") && i >= (eventsStack.size() - 2)) {
                    session.loginfo = session.loginfo + "TIMEOUT;";
                    return "error.mrf.connect.timeout";
                }
            }
        }
    }
    catch (e) {
        log.debug("Log: {}", e);
        return "error.mrf.connect.exception";
    }
    return "error.mrf.connect.others";
}
function setrelease(session, event, localParams) {
    var log = session.log;
    try {
        session["mrf"]["callstate"] = "Released";
        session["mrf"]["releasetime"] = Math.floor(new Date() / 1000);
        return "success";
    }
    catch (e) {
        log.debug("Log: {}", e);
        return "error.release";
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kdWxlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibW9kdWxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFXQSxJQUFLLFlBTUo7QUFORCxXQUFLLFlBQVk7SUFDZixpQ0FBaUIsQ0FBQTtJQUNqQixtQ0FBa0IsQ0FBQTtJQUNsQiw2Q0FBMkIsQ0FBQTtJQUMzQiwyQkFBUyxDQUFBO0lBQ1QsaUNBQWUsQ0FBQTtBQUNqQixDQUFDLEVBTkksWUFBWSxLQUFaLFlBQVksUUFNaEI7QUFzREQsSUFBSyxRQUdKO0FBSEQsV0FBSyxRQUFRO0lBQ1gsK0JBQW1CLENBQUE7SUFDbkIsNEJBQWdCLENBQUE7QUFDbEIsQ0FBQyxFQUhJLFFBQVEsS0FBUixRQUFRLFFBR1o7QUF1QkQsSUFBSyxrQkFJSjtBQUpELFdBQUssa0JBQWtCO0lBQ3RCLHVDQUFpQixDQUFBO0lBQ2pCLHlDQUFtQixDQUFBO0lBQ25CLHVDQUFpQixDQUFBO0FBQ2xCLENBQUMsRUFKSSxrQkFBa0IsS0FBbEIsa0JBQWtCLFFBSXRCO0FBRUQsSUFBSyxtQkFJSjtBQUpELFdBQUssbUJBQW1CO0lBQ3ZCLCtEQUFTLENBQUE7SUFDVCxtRUFBVyxDQUFBO0lBQ1gsdUVBQWEsQ0FBQTtBQUNkLENBQUMsRUFKSSxtQkFBbUIsS0FBbkIsbUJBQW1CLFFBSXZCO0FBZ0NELElBQUssd0JBRUo7QUFGRCxXQUFLLHdCQUF3QjtJQUM1QiwyRUFBK0MsQ0FBQTtBQUNoRCxDQUFDLEVBRkksd0JBQXdCLEtBQXhCLHdCQUF3QixRQUU1QjtBQUVELElBQUsseUJBRUo7QUFGRCxXQUFLLHlCQUF5QjtJQUM3QiwwREFBNkIsQ0FBQTtBQUM5QixDQUFDLEVBRkkseUJBQXlCLEtBQXpCLHlCQUF5QixRQUU3QjtBQW1GRCxDQUFDO0FBQ0QsQ0FBQztBQTRCRCxTQUFTLGVBQWUsQ0FBQyxPQUFhLEVBQUUsS0FBVyxFQUFFLFdBQWdCO0lBQ2pFLElBQUksR0FBRyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUM7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O29CQUM3QyxPQUFPLDJCQUEyQixDQUFDO2lCQUN0QzthQUNKO1NBQ0o7S0FDSjtJQUFDLE9BQU8sQ0FBQyxFQUFFO1FBQ1IsR0FBRyxDQUFDLEtBQUssQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDeEIsT0FBTyw2QkFBNkIsQ0FBQztLQUN4QztJQUNELE9BQU8sMEJBQTBCLENBQUM7QUFDdEMsQ0FBQztBQUVELFNBQVMsVUFBVSxDQUFDLE9BQWEsRUFBRSxLQUFXLEVBQUUsV0FBZ0I7SUFDNUQsSUFBSSxHQUFHLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQztJQUV0QixJQUFJO1FBQ0EsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLFdBQVcsQ0FBQyxHQUFJLFVBQVUsQ0FBQztRQUMxQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsYUFBYSxDQUFDLEdBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLElBQUksRUFBRSxHQUFDLElBQUksQ0FBQyxDQUFDO1FBQzdELE9BQU8sU0FBUyxDQUFDO0tBQ3BCO0lBQUMsT0FBTyxDQUFDLEVBQUU7UUFDUixHQUFHLENBQUMsS0FBSyxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUN4QixPQUFPLGVBQWUsQ0FBQztLQUMxQjtBQUNMLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJcbi8vaW50ZXJmYWNlIGRlZmluaXRpb25cclxuXHJcbmludGVyZmFjZSBMZWcge1xyXG4gIGFkZHJlc3MgOiBzdHJpbmc7XHJcbiAgbmFtZSA6IHN0cmluZ1xyXG59XHJcbmludGVyZmFjZSBDYWxsIHtcclxuICBzdGF0ZSA6IG51bWJlclxyXG59XHJcblxyXG5lbnVtIENhcGFiaWxpdGllcyB7XHJcbiAgUkVMMVhYID0gXCJSRUwxWFhcIixcclxuICBGT1JLSU5HPSBcIkZPUktJTkdcIixcclxuICBQUkVDT05ESVRJT049XCJQUkVDT05ESVRJT05cIixcclxuICBQRU09XCJQRU1cIixcclxuICBVUERBVEU9XCJVUERBVEVcIlxyXG59XHJcblxyXG5pbnRlcmZhY2UgTWVzc2FnZSB7XHJcbiAgbWV0aG9kIDogW3N0cmluZ107XHJcbiAgdHlwZSA6IFtzdHJpbmddO1xyXG4gIGJvZHkgOiBbc3RyaW5nXVxyXG59XHJcblxyXG5pbnRlcmZhY2UgU0lQIHtcclxuICBjYXBhYmlsaXRpZXMgOiBbQ2FwYWJpbGl0aWVzXTtcclxuICBtZXNzYWdlIDogTWVzc2FnZVxyXG59XHJcblxyXG5pbnRlcmZhY2UgQ2FsbFN0YXJ0IHtcclxuICBjb250YWN0IDogc3RyaW5nO1xyXG4gIGNhdXNlOiBzdHJpbmc7XHJcbiAgbGVnIDogc3RyaW5nXHJcbn1cclxuXHJcbmludGVyZmFjZSBDYWxsUG9sbCB7XHJcbiAgbmFtZTogc3RyaW5nO1xyXG4gIHR5cGU6IHN0cmluZztcclxuICBsZWc6IHN0cmluZ1xyXG59XHJcblxyXG5pbnRlcmZhY2UgRXZlbnQge1xyXG4gIG5hbWUgOiBzdHJpbmc7XHJcbiAgY2FsbFN0YXJ0PyA6IENhbGxTdGFydDtcclxuICBjYWxsUG9sbD8gOiBDYWxsUG9sbFxyXG59XHJcblxyXG5cclxuaW50ZXJmYWNlIE9DQ1BFdmVudCB7XHJcbiAgY2FsbGlkIDogc3RyaW5nO1xyXG4gIGNhbGwgOiBDYWxsO1xyXG4gIGFzIDogc3RyaW5nO1xyXG4gIGV2ZW50dGltZSA6IG51bWJlcjtcclxuICBTSVAgOiBTSVA7XHJcbiAgZXZlbnQ6IEV2ZW50XHJcbn1cclxuXHJcbmludGVyZmFjZSBFdmVudHMge1xyXG4gIFN1Y2Nlc3NSZXNwb25zZVBvbGxFdmVudD8gOiBzdHJpbmc7XHJcbiAgUmF3Q29udGVudFBvbGxFdmVudD8gOiBzdHJpbmc7XHJcbiAgSW5mb1BvbGxFdmVudD86IHN0cmluZ1xyXG59XHJcbi8qKlxyXG4gIERlZmluZSBoZWFkZXIgdmFyaWFibGVzIHVzZWQgYnkgYXBwbGljYXRpb25cclxuKi9cclxuaW50ZXJmYWNlIEhlYWRlclZhcnMge1xyXG4gIGRpc2FibGVTZW5kRGVmYXVsdFJlYXNvbj8gOiBzdHJpbmc7XHJcbiAgZGlzYWJsZVNlbmROb0Fuc3dlclJlYXNvbj8gOiBzdHJpbmdcclxufVxyXG5cclxuZW51bSBBbm5vdHlwZSB7XHJcbiAgQ09OTkVDVCA9IFwiQ09OTkVDVFwiLFxyXG4gIFJJTkdJTkcgPSBcIlJJTkdcIlxyXG59XHJcblxyXG5pbnRlcmZhY2UgUmluZ2luZ1RvbmUge1xyXG4gIGFubm9fbmFtZSA6IHN0cmluZztcclxuICBhbm5vX3R5cGUgOiBBbm5vdHlwZVxyXG59XHJcblxyXG5pbnRlcmZhY2UgU2Vzc2lvbiB7XHJcbiAgbG9nIDogYW55O1xyXG4gIGluQ2FwYWJpbGl0aWVzIDogW0NhcGFiaWxpdGllc107XHJcbiAgb3V0Q2FwYWJpbGl0aWVzPyA6IHN0cmluZztcclxuICBldmVudHM/IDogc3RyaW5nO1xyXG4gIGhlYWRlcnJ1bGV2YXI/IDogc3RyaW5nO1xyXG4gIGhlYWRlcnJ1bGVzc2VsZWN0PyA6IHN0cmluZztcclxuICByaW5naW5ndG9uZXM/IDogc3RyaW5nO1xyXG4gIHNlbmRBY3Rpb24/IDogc3RyaW5nIDtcclxuICBTSVBIZWxwZXIgOiBhbnk7XHJcbiAgU0lQSW5pdGlhbEludml0ZT8gOiBhbnk7XHJcbiAgU0lQTWVzc2FnZT8gOiBhbnk7XHJcbiAgU0lQTWVzc2FnZVR5cGU/IDogYW55XHJcbn1cclxuXHJcblxyXG5lbnVtIENhbGxQb2xsQWN0aW9uVHlwZSB7XHJcbiBBY2NlcHQgPSBcImFjY2VwdFwiLFxyXG4gRm9yd2FyZCA9IFwiZm9yd2FyZFwiLFxyXG4gUmVqZWN0ID0gXCJyZWplY3RcIixcclxufVxyXG5cclxuZW51bSBDYWxsU3RhcnRBY3Rpb25UeXBlIHtcclxuIEFib3J0ID0gMCxcclxuIEZvcndhcmQgPSAxLFxyXG4gUmVqZWN0TXJmID0gMlxyXG59XHJcblxyXG5cclxuXHJcbi8qKlxyXG4gU2V0IGFjdGlvbiBmb3IgQ2FsbFN0YXJ0IGV2ZW50XHJcbiovXHJcbmludGVyZmFjZSBDYWxsU3RhcnRBY3Rpb24ge1xyXG4gdHlwZSA6IENhbGxTdGFydEFjdGlvblR5cGU7XHJcbiBlcnJvcmNvZGUgOiBudW1iZXI7XHJcbiBjYXVzZSA6IHN0cmluZyA7XHJcbiB1cmkgOiBzdHJpbmc7XHJcbiBlYXJseW1lZGlhIDogbnVtYmVyO1xyXG4gbGVnbmFtZSA6IHN0cmluZyBcclxufVxyXG5cclxuLyoqXHJcbiBTZXQgYWN0aW9uIGZvciBDYWxsUG9sbCBldmVudFxyXG4qL1xyXG5pbnRlcmZhY2UgQ2FsbFBvbGxBY3Rpb24ge1xyXG4gdHlwZSA6IENhbGxQb2xsQWN0aW9uVHlwZVxyXG59XHJcblxyXG5cclxuLyoqXHJcbiBBcHBsaWNhdGlvbiBjYW4gc2V0IGFjdGlvbiBmb3IgYSBzcGVjaWZpYyBsZWcsIHRoaXMgaXMgYXBwbGljYWJsZSBmb3IgTVJGIGNvbnRhY3RcclxuICovXHJcbmludGVyZmFjZSBMZWdBY3Rpb24ge1xyXG4gdHlwZSA6IENhbGxTdGFydEFjdGlvblR5cGUgO1xyXG4gbGVnYWN0aW9uIDogc3RyaW5nXHJcbn1cclxuXHJcbmVudW0gTWVkaWFPcGVyYXRpb25BY3Rpb25UeXBlIHtcclxuIFBlcmZvcm1NZWRpYU9wZXJhdGlvbiA9IFwicGVyZm9ybU1lZGlhT3BlcmF0aW9uXCJcclxufVxyXG5cclxuZW51bSBNZWRpYU9wZXJhdGlvbkNvbnRlbnRUeXBlIHtcclxuIE1TTUwgPSBcImFwcGxpY2F0aW9uL21zbWwreG1sXCJcclxufVxyXG5cclxuaW50ZXJmYWNlIFBlcmZvcm1NZWRpYU9wZXJhdGlvbiB7XHJcbiBDb250ZW50VHlwZSA6IE1lZGlhT3BlcmF0aW9uQ29udGVudFR5cGU7XHJcbiBDb250ZW50IDogc3RyaW5nXHJcbn1cclxuXHJcbmludGVyZmFjZSBNZWRpYU9wZXJhdGlvbkFjdGlvbiB7XHJcbiB0eXBlIDogbnVtYmVyO1xyXG4gbGVnYWN0aW9uIDogTWVkaWFPcGVyYXRpb25BY3Rpb25UeXBlO1xyXG4gcGVyZm9ybU1lZGlhT3BlcmF0aW9uIDogUGVyZm9ybU1lZGlhT3BlcmF0aW9uXHJcbn1cclxuXHJcbmludGVyZmFjZSBBY3Rpb24ge1xyXG4gYWN0aW9uIDogYW55IFxyXG59XHJcblxyXG5cclxuaW50ZXJmYWNlIEhlYWRlciB7XHJcbiBoZWFkZXIgOiBzdHJpbmc7XHJcbiB2YWx1ZSA6IHN0cmluZztcclxufVxyXG5cclxuaW50ZXJmYWNlIFFIZWFkZXIge1xyXG4gUHJpdmFjeSA6IHN0cmluZztcclxuIFJlYXNvbiA6IHN0cmluZyA7XHJcbn1cclxuXHJcbmludGVyZmFjZSBQYXJhbWV0ZXIge1xyXG4gdHJhbnNwb3J0IDogc3RyaW5nO1xyXG4gdXNlciA6IHN0cmluZyA7XHJcbn1cclxuXHJcbmludGVyZmFjZSBVUkkge1xyXG4gc2NoZW1lIDogc3RyaW5nO1xyXG4gYXV0aG9yaXR5IDogc3RyaW5nIDtcclxuIGdyIDogc3RyaW5nIDtcclxuIGhvc3Q6IHN0cmluZyA7XHJcbiBsciA6IHN0cmluZyA7XHJcbiBtYWRkciA6IHN0cmluZyA7XHJcbiBwb3J0IDogbnVtYmVyICA7XHJcbiB1c2VyIDogc3RyaW5nIDtcclxuIHBhcmFtZXRlcnMgOiBbUGFyYW1ldGVyXTtcclxuIHFoZWFkZXIgOiBbUUhlYWRlcl07XHJcbn1cclxuXHJcbmludGVyZmFjZSBBZGRyZXNzIHtcclxuIGRpc3BsYXlOYW1lIDogc3RyaW5nO1xyXG4gdXJpIDogVVJJIFxyXG59XHJcblxyXG5pbnRlcmZhY2UgSGlzdG9yeUluZm8gaW1wbGVtZW50cyBIZWFkZXIge1xyXG4gYWRkcmVzcyA6IEFkZHJlc3M7XHJcbiBpbmRleCA6IHN0cmluZ1xyXG59XHJcblxyXG5pbnRlcmZhY2UgUEFJIGltcGxlbWVudHMgSGVhZGVyICB7XHJcbiBhZGRyZXNzIDogQWRkcmVzc1xyXG59XHJcblxyXG5pbnRlcmZhY2UgRnJvbSBpbXBsZW1lbnRzIEhlYWRlciB7XHJcbiBhZGRyZXNzIDogQWRkcmVzcztcclxuIHRhZyA6IHN0cmluZyA7XHJcbn1cclxuXHJcbmludGVyZmFjZSBUbyBpbXBsZW1lbnRzIEhlYWRlciB7XHJcbiBhZGRyZXNzIDogQWRkcmVzcztcclxuIHRhZyA6IHN0cmluZztcclxufVxyXG5cclxuaW50ZXJmYWNlIFBDViBpbXBsZW1lbnRzIEhlYWRlciB7XHJcbiBpY2lkX2dlbmVyYXRlZF9hdDogc3RyaW5nIDtcclxuIGljaWRfdmFsdWUgOiBzdHJpbmcgO1xyXG4gb2FpZCA6IHN0cmluZztcclxuIHRhaWQgOiBzdHJpbmc7XHJcbiBvc2lkIDogc3RyaW5nO1xyXG4gdHNpZCA6IHN0cmluZztcclxufVxyXG5cclxuaW50ZXJmYWNlIFJlc3VsdENvZGUge1xyXG4gIHJlc3VsdENvZGUgOiBzdHJpbmcgO1xyXG59XHJcblxuOy8vTUFJTkJMT0NLXG47XG4vKlxuLy9jb25maWcgaXMgXCJtcmZfYW5ub3VuY2VtZW50c1wiXG57XG4gIFwiYW5ub1Rlc3RcIjoge1xuICAgIFwibWF4dGltZVwiOiAxNTAwLFxuICAgIFwicGF0aFwiOiBcImZpbGU6Ly8vdG1wL2Fubm9zL1wiLFxuICAgIFwidmFyaWFibGVcIjogXCJcIixcbiAgICBcImJhcmdlXCI6IDEsXG4gICAgXCJwcm9tcHRcIjogXCJ0ZXN0QW5uby53YXZcIixcbiAgICBcImR0bWZcIjoge1xuICAgICAgXCJjbGVhcmRiXCI6IDEsXG4gICAgICBcImlkdFwiOiAxLFxuICAgICAgXCJmZHRcIjogMSxcbiAgICAgIFwibWluXCI6IDEsXG4gICAgICBcIm1heFwiOiAxLFxuICAgICAgXCJydGZcIjogXCIqXCIsXG4gICAgICBcImNhbmNlbFwiOiBcIiNcIlxuICAgIH0sXG4gICAgXCJhbm5pZFwiOiBcImFubm9Qcm9tcHRDb2xsZWN0XCIsXG4gICAgXCJpbnRlcnZhbFwiOiAxMDAsXG4gICAgXCJpdGVyYXRlXCI6IDEsXG4gICAgXCJjbGVhcmRiXCI6IDFcbiAgfSxcbn1cblxuKi9cblxuZnVuY3Rpb24gaW5wdXR2YWxpZGF0aW9uKHNlc3Npb24gOiBhbnksIGV2ZW50IDogYW55LCBsb2NhbFBhcmFtczogYW55ICl7XG4gICAgbGV0IGxvZyA9IHNlc3Npb24ubG9nO1xuXG4gICAgdHJ5IHtcblxuICAgICAgICAvL3NpcCBpbnZpdGUgaXMgaW4gI3Nlc3Npb25bXCJzX1NJUEludml0ZVwiXVxuICAgICAgICBpZiAoIHNlc3Npb25bXCJzX1NJUEludml0ZVwiXSAhPSBudWxsICkge1xuICAgICAgICAgICAgaWYoIHNlc3Npb25bXCJzX1NJUEludml0ZVwiXVtcImV2ZW50LXR5cGVcIl0hPT1udWxsICYmIChzZXNzaW9uW1wic19TSVBJbnZpdGVcIl1bXCJldmVudC10eXBlXCJdPT09XCJzaXBcIiB8fCBzZXNzaW9uW1wic19TSVBJbnZpdGVcIl1bXCJldmVudC10eXBlXCJdPT09XCJvY2NwXCIpKSB7XG4gICAgICAgICAgICAgICAgaWYoIHNlc3Npb25bXCJzX1NJUEludml0ZVwiXVtcImV2ZW50LW5hbWVcIl0hPT1udWxsICYmIHNlc3Npb25bXCJzX1NJUEludml0ZVwiXVtcImV2ZW50LW5hbWVcIl0gPT09IFwic2lwLmNhbGxTdGFydC5OT05FXCIpXG4gICAgICAgICAgICAgICAgICAgIGxvZy5kZWJ1ZyhcImdvdCBzaXAgaW52aXRlXCIpO1xuICAgICAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFwiZXJyb3IuaW5wdXQuc2lwaW52aXRlaW5jb3JyZWN0ZXZlbnRuYW1lXCI7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiBcImVycm9yLmlucHV0LnNpcGludml0ZWluY29ycmVjdGV2ZW50dHlwZVwiO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIFwiZXJyb3IuaW5wdXQuc2lwaW52aXRlbWlzc2luZ1wiO1xuICAgICAgICB9XG5cbi8vaW50ZXJpbVxuICAgIHJldHVybiBcInRydWVcIjtcblxuXG5cblxuICAgICAgICAvL2Fubm91bmNlbWVudCBzdHJpbmdcbiAgICAgICAgaWYgKCBldmVudFtcImFubm91bmNlbWVudFwiXSAhPSBudWxsICkge1xuICAgICAgICAgICAgbG9nLmRlYnVnKFwiYW5ub3VuY2VtZW50OiB7fVwiLCBldmVudFtcImFubm91bmNlbWVudFwiXSk7XG4gICAgICAgICAgICAgICAgc2Vzc2lvbltcIm1yZlwiXVtcImFubm91bmNlbWVudFwiXSA9IGV2ZW50W1wiYW5ub3VuY2VtZW50XCJdOyAgICAgICAgICAgXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gXCJlcnJvci5pbnB1dC5hY3Rpb25taXNzaW5nXCI7XG4gICAgICAgIH1cblxuICAgICAgICAvL3Byb21wdGFuZGNvbGxlY3QsIHBsYXlhbm5vdW5jZW1lbnRcbiAgICAgICAgaWYgKCAoZXZlbnRbXCJhY3Rpb25cIl0gIT0gbnVsbCkgJiYgKChldmVudFtcImFjdGlvblwiXT09PVwicHJvbXB0YW5kY29sbGVjdFwiKSB8fCAoZXZlbnRbXCJhY3Rpb25cIl09PT1cInBsYXlhbm5vdW5jZW1lbnRcIikpICkge1xuICAgICAgICAgICAgbG9nLmRlYnVnKFwiYWN0aW9uOiB7fVwiLCBldmVudFtcImFjdGlvblwiXSk7XG4gICAgICAgICAgICBpZiAoIGV2ZW50W1wiYWN0aW9uXCJdPT09XCJwcm9tcHRhbmRjb2xsZWN0XCIgKSBcbiAgICAgICAgICAgICAgICBzZXNzaW9uW1wibXJmXCJdW1wiYWN0aW9uXCJdID0gXCJwcm9tcHRhbmRjb2xsZWN0XCI7XG4gICAgICAgICAgICBlbHNlIGlmICggZXZlbnRbXCJhY3Rpb25cIl09PT1cInBsYXlhbm5vdW5jZW1lbnRcIiApIFxuICAgICAgICAgICAgICAgIHNlc3Npb25bXCJtcmZcIl1bXCJhY3Rpb25cIl0gPSBcInBsYXlhbm5vdW5jZW1lbnRcIjtcbiAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICByZXR1cm4gXCJlcnJvci5pbnB1dC5hY3Rpb25pbmNvcnJlY3RcIjsgICAgICAgICAgICBcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBcImVycm9yLmlucHV0LmFjdGlvbm1pc3NpbmdcIjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vZWFybHkgZGlhbG9nIGlzIGJvb2xlYW4gdHJ1ZS9mYWxzZVxuICAgICAgICBpZiAoIGV2ZW50W1wiZWFybHlkaWFsb2dcIl0gIT0gbnVsbCApIHtcbiAgICAgICAgICAgIGxvZy5kZWJ1ZyhcImVhcmx5ZGlhbG9nOiB7fVwiLCBldmVudFtcImVhcmx5ZGlhbG9nXCJdKTtcbiAgICAgICAgICAgIGlmICggZXZlbnRbXCJlYXJseWRpYWxvZ1wiXSA9PT0gdHJ1ZSkge1xuICAgICAgICAgICAgICAgIHNlc3Npb25bXCJtcmZcIl1bXCJlYXJseWRpYWxvZ1wiXSA9IHRydWU7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFwidHJ1ZVwiO1xuICAgICAgICAgICAgfSBlbHNlIGlmICggZXZlbnRbXCJlYXJseWRpYWxvZ1wiXSA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICBzZXNzaW9uW1wibXJmXCJdW1wiZWFybHlkaWFsb2dcIl0gPSBmYWxzZTtcbiAgICAgICAgICAgICAgICByZXR1cm4gXCJmYWxzZVwiO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gXCJlcnJvci5pbnB1dC5lYXJseWRpYWxvZ2luY29ycmVjdFwiO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIFwiZXJyb3IuaW5wdXQuZWFybHlkaWFsb2dcIjtcbiAgICAgICAgfVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgbG9nLmRlYnVnKFwiTG9nOiB7fVwiLCBlKTtcbiAgICAgICAgcmV0dXJuIFwiZXJyb3IuZXhjZXB0aW9uXCI7XG4gICAgfVxufVxuXG5mdW5jdGlvbiBhcm1NUkZldmVudHMoc2Vzc2lvbkRhdGE6YW55LGV2ZW50RGF0YTphbnksbG9jYWxQYXJhbXM6YW55KTogYW55IHtcbiBsZXQgcmV0OiBSZXN1bHRDb2RlIDtcblxuICAgIGxldCBzdGF0dXMyIDogc3RyaW5nO1xuICAgIGxldCBldmVudHMgOiBFdmVudHM7XG4gICAgZXZlbnRzID0gZXZlbnRzIHx8IHt9O1xuICAgIGV2ZW50cy5JbmZvUG9sbEV2ZW50PVwibnVsbFwiO1xuICAgIGV2ZW50cy5TdWNjZXNzUmVzcG9uc2VQb2xsRXZlbnQ9XCJudWxsXCI7XG4gICAgZXZlbnRzLlJhd0NvbnRlbnRQb2xsRXZlbnQ9XCJ0ZXN0L3Rlc3RcIjtcblxuICAgIGxldCBoZWFkZXJWYXJzIDogSGVhZGVyVmFycztcbiAgICBoZWFkZXJWYXJzID0gaGVhZGVyVmFycyB8fCB7fTtcbiAgICBoZWFkZXJWYXJzLmRpc2FibGVTZW5kRGVmYXVsdFJlYXNvbiA9IFwiRGlzYWJsZWRcIjtcbiAgICBoZWFkZXJWYXJzLmRpc2FibGVTZW5kTm9BbnN3ZXJSZWFzb24gPSBcIkRpc2FibGVkXCI7XG5cbiAgICBsZXQgcmluZ2luZ1RvbmVzIDogW1JpbmdpbmdUb25lXTtcbiAgICByaW5naW5nVG9uZXMgPSByaW5naW5nVG9uZXMgfHwgW107XG4gICAgbGV0IGNvbWYgOiBSaW5naW5nVG9uZTtcbiAgICBjb21mID0gY29tZiB8fCB7fTtcbiAgICBjb21mLmFubm9fbmFtZT1cImNvbWZvcnRcIjtcbiAgICBjb21mLmFubm9fdHlwZT1Bbm5vdHlwZS5DT05ORUNUO1xuICAgIGxldCByaW5nIDogUmluZ2luZ1RvbmU7XG4gICAgcmluZyA9IHJpbmcgfHwge307XG4gICAgcmluZy5hbm5vX25hbWU9XCJyaW5naW5nXCI7XG4gICAgcmluZy5hbm5vX3R5cGU9QW5ub3R5cGUuUklOR0lORztcbiAgICByaW5naW5nVG9uZXMucHVzaChjb21mLCByaW5nKTtcblxuICAgIGxldCBjYXBhYmlsaXRpZXMgPSBzZXNzaW9uRGF0YS5pbkNhcGFiaWxpdGllcztcbiAgICBpZiggY2FwYWJpbGl0aWVzIT1udWxsKXtcbiAgICAgICAgY2FwYWJpbGl0aWVzLnB1c2goQ2FwYWJpbGl0aWVzLlBFTSk7XG4gICAgICAgIGNhcGFiaWxpdGllcy5wdXNoKENhcGFiaWxpdGllcy5GT1JLSU5HKTtcbiAgICAgICAgc2Vzc2lvbkRhdGEub3V0Q2FwYWJpbGl0aWVzID0gSlNPTi5zdHJpbmdpZnkoY2FwYWJpbGl0aWVzKTtcbiAgICB9XG5cbiAgICBzZXNzaW9uRGF0YS5ldmVudHMgPSBKU09OLnN0cmluZ2lmeShldmVudHMpO1xuICAgIHNlc3Npb25EYXRhLmhlYWRlcnJ1bGV2YXI9SlNPTi5zdHJpbmdpZnkoaGVhZGVyVmFycyk7XG4gICAgc2Vzc2lvbkRhdGEuaGVhZGVycnVsZXNzZWxlY3QgPSBcIlNpcFNlcnZpY2VTcGVjaWZpY1J1bGVzU2V0XCI7XG4gICAgc2Vzc2lvbkRhdGEucmluZ2luZ3RvbmVzID0gSlNPTi5zdHJpbmdpZnkocmluZ2luZ1RvbmVzKTtcbiAgICBzZXNzaW9uRGF0YS51cHN0cmVhbUNhcGFiaWxpdGllcz1KU09OLnN0cmluZ2lmeShbXSk7XG5cbiAgICByZXR1cm4gXCJzdWNjZXNzXCI7XG59XG5cblxuZnVuY3Rpb24gaGFuZGxlMjAwT0tJTlZJVEUoc2Vzc2lvbjphbnksZXZlbnQ6T0NDUFNJUC5PQ0NQRXZlbnQsbG9jYWxQYXJhbXM6YW55KSB7XG4gICAgbGV0IGxvZyA9IHNlc3Npb24ubG9nO1xuXG4gICAgdHJ5IHtcbiAgICAgICAgLy90aGUgcmVjZWl2ZWQgZXZlbnQgaXMgbm93IGluIGxvY2FsUGFyYW1zXG4gICAgICAgIGxldCBldmVudERhdGEgPSBsb2NhbFBhcmFtcy5tZXNzYWdlO1xuICAgICAgICAvL3Nlc3Npb24uZXZlbnRzID0gbnVsbDtcbiAgICAgICAgc2Vzc2lvbltcIm1yZlwiXVtcImhlYWRlcnJ1bGV2YXI9bnVsbFwiXTtcbiAgICAgICAgc2Vzc2lvbltcIm1yZlwiXVtcImhlYWRlcnJ1bGVzc2VsZWN0XCJdID0gbnVsbDtcbiAgICAgICAgc2Vzc2lvbltcIm1yZlwiXVtcInJpbmdpbmd0b25lc1wiXSA9IG51bGw7XG5cbiAgICAgICAgbGV0IHBvbGxBY3Rpb24gOiBDYWxsUG9sbEFjdGlvbjtcbiAgICAgICAgcG9sbEFjdGlvbiA9IHBvbGxBY3Rpb24gfHwge307XG4gICAgICAgIHBvbGxBY3Rpb24udHlwZSA9IENhbGxQb2xsQWN0aW9uVHlwZS5BY2NlcHQ7XG4gICAgICAgIHNlc3Npb25bXCJtcmZcIl1bXCJzZW5kQWN0aW9uXCJdID0gSlNPTi5zdHJpbmdpZnkocG9sbEFjdGlvbik7XG5cbiAgICAgICAgc2Vzc2lvbltcIm1yZlwiXVtcInRpbWUyMDBPS0lOVklURVwiXSAgPSBNYXRoLmZsb29yKG5ldyBEYXRlKCkvMTAwMCk7XG5cbiAgICAgICAgLy9zYXZlIHRvIHRhZ1xuICAgICAgICBsZXQgdG8gOiBUbyA9IGV2ZW50RGF0YS5TSVAuVG87XG4gICAgICAgIGlmKCB0byE9bnVsbCkge1xuICAgICAgICAgICAgbG9nLmRlYnVnKFwicmVjZWl2ZWQgZnJvbSBNUkYgdG8gdGFnOnt9XCIsdG8pO1xuICAgICAgICAgICAgc2Vzc2lvbltcIm1yZlwiXVtcImNhbGxzdGF0ZVwiXSAgPSBcIk1SRkNPTk5FQ1RFRDIwME9LXCI7XG4gICAgICAgICAgICBzZXNzaW9uW1wibXJmXCJdW1wiZG93blN0cmVhbVRvVGFnXCJdPXRvLnRhZztcbiAgICAgICAgICAgIHJldHVybiBcInN1Y2Nlc3NcIjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxvZy5kZWJ1ZyhcInJlY2VpdmVkIGZyb20gTVJGIG5vIHRvIHRhZzp7fVwiLHRvKTtcbiAgICAgICAgICAgIHJldHVybiBcImVycm9yLm5vdG90YWdcIjtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhcImhhbmRsZTIwME9LSU5WSVRFIExvZzoge31cIiwgZSk7XG4gICAgICAgIHJldHVybiBcImVycm9yLmV4Y2VwdGlvblwiO1xuICAgIH1cbn1cblxuZnVuY3Rpb24gaGFuZGxlMjAwT0tJTkZPKHNlc3Npb246YW55LGV2ZW50Ok9DQ1BTSVAuRXZlbnQsbG9jYWxQYXJhbXM6TG9jYWxQYXJhbWV0ZXJzKTogYW55e1xuICAgIGxldCBsb2cgPSBzZXNzaW9uLmxvZztcblxuICAgIHRyeSB7ICAgICAgICBcbiAgICAgICAgc2Vzc2lvbltcIm1yZlwiXVtcInRpbWUyMDBPS0lORk9cIl0gID0gTWF0aC5mbG9vcihuZXcgRGF0ZSgpLzEwMDApO1xuICAgICAgICBzZXNzaW9uW1wibXJmXCJdW1wiY2FsbHN0YXRlXCJdICA9IFwiTVJGQ09OTkVDVEVEXCI7XG4gICAgICAgIGlmIChldmVudC5TSVAuY29udGVudC5qc29uLm1zbWwuZXZlbnQubmFtZVsyXSE9bnVsbCkge1xuICAgICAgICAgICAgaWYgKGV2ZW50LlNJUC5jb250ZW50Lmpzb24ubXNtbC5ldmVudC5uYW1lWzJdPT1cImR0bWYuZGlnaXRzXCIpIHtcbiAgICAgICAgICAgICAgICBsb2cuZGVidWcoXCJHb3QgRFRNRiBkaWdpdHM7XCIpO1xuICAgICAgICAgICAgICAgIGlmIChldmVudC5TSVAuY29udGVudC5qc29uLm1zbWwuZXZlbnQudmFsdWVbMV0hPW51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgc2Vzc2lvbltcIm1yZlwiXVtcImR0bWZkaWdpdFwiXT1ldmVudC5TSVAuY29udGVudC5qc29uLm1zbWwuZXZlbnQudmFsdWVbMV07ICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHNlc3Npb25bXCJtcmZcIl1bXCJkdG1mZGlnaXRcIl09XCIwXCI7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBsb2cuZGVidWcoXCJObyBEVE1GIGRpZ2l0cztcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhcIkxvZzoge31cIiwgZSk7XG4gICAgICAgIHJldHVybiBcImVycm9yLmV4Y2VwdGlvblwiO1xuICAgIH1cbiAgICByZXR1cm4gc2Vzc2lvbltcIm1yZlwiXVtcImR0bWZkaWdpdFwiXTtcbn1cblxuZnVuY3Rpb24gY2FsbEFuc3dlcmVkKHNlc3Npb24gOiBhbnksIGV2ZW50IDogYW55LCBsb2NhbFBhcmFtczogYW55ICl7XG4gICAgbGV0IGxvZyA9IHNlc3Npb24ubG9nO1xuXG4gICAgdHJ5IHsgICAgICAgIFxuICAgICAgICBzZXNzaW9uW1wibXJmXCJdW1wiY2FsbHN0YXRlXCJdICA9IFwiQU5TV0VSRURcIjtcbiAgICAgICAgc2Vzc2lvbltcIm1yZlwiXVtcImFuc3dlcnRpbWVcIl0gID0gTWF0aC5mbG9vcihuZXcgRGF0ZSgpLzEwMDApO1xuICAgICAgICByZXR1cm4gXCJzdWNjZXNzXCI7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBsb2cuZGVidWcoXCJMb2c6IHt9XCIsIGUpO1xuICAgICAgICByZXR1cm4gXCJlcnJvci5leGNlcHRpb25cIjtcbiAgICB9XG59XG5cbmZ1bmN0aW9uIGNoZWNrRGlzY29ubmVjdFJlYXNvbihzZXNzaW9uIDogYW55LCBldmVudCA6IGFueSwgbG9jYWxQYXJhbXM6IGFueSApe1xuICAgIGxldCBsb2cgPSBzZXNzaW9uLmxvZztcblxuICAgIHRyeSB7ICBcbiAgICAgICAgc2Vzc2lvbltcIm1yZlwiXVtcImNhbGxzdGF0ZVwiXSAgPSBcIkNvbm5lY3RFcnJvclwiO1xuICAgICAgICBzZXNzaW9uW1wibXJmXCJdW1wiY29ubmVjdGVycm9ydGltZVwiXSAgPSBNYXRoLmZsb29yKG5ldyBEYXRlKCkvMTAwMCk7ICAgICAgICBcbiAgICAgICAgbGV0IGV2ZW50c1N0YWNrPWV2ZW50WydldmVudHMtc3RhY2snXTtcbiAgICAgICAgaWYoIGV2ZW50c1N0YWNrIT1udWxsICYmIGV2ZW50c1N0YWNrLnNpemUoKT4wICl7XG4gICAgICAgICAgICBmb3IodmFyIGk9ZXZlbnRzU3RhY2suc2l6ZSgpLTE7aT49MDtpLS0pe1xuICAgICAgICAgICAgICAgIGlmKCBldmVudHNTdGFjay5nZXQoaSkuZXF1YWxzKFwibGVnLnRpbWVvdXRcIikgJiYgaT49KGV2ZW50c1N0YWNrLnNpemUoKS0yKSl7XG4gICAgICAgICAgICAgICAgICAgIHNlc3Npb24ubG9naW5mbyA9IHNlc3Npb24ubG9naW5mbytcIlRJTUVPVVQ7XCI7IFxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gXCJlcnJvci5tcmYuY29ubmVjdC50aW1lb3V0XCI7ICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBsb2cuZGVidWcoXCJMb2c6IHt9XCIsIGUpO1xuICAgICAgICByZXR1cm4gXCJlcnJvci5tcmYuY29ubmVjdC5leGNlcHRpb25cIjtcbiAgICB9ICAgICAgICBcbiAgICByZXR1cm4gXCJlcnJvci5tcmYuY29ubmVjdC5vdGhlcnNcIjtcbn1cblxuZnVuY3Rpb24gc2V0cmVsZWFzZShzZXNzaW9uIDogYW55LCBldmVudCA6IGFueSwgbG9jYWxQYXJhbXM6IGFueSApe1xuICAgIGxldCBsb2cgPSBzZXNzaW9uLmxvZztcblxuICAgIHRyeSB7ICBcbiAgICAgICAgc2Vzc2lvbltcIm1yZlwiXVtcImNhbGxzdGF0ZVwiXSAgPSBcIlJlbGVhc2VkXCI7XG4gICAgICAgIHNlc3Npb25bXCJtcmZcIl1bXCJyZWxlYXNldGltZVwiXSAgPSBNYXRoLmZsb29yKG5ldyBEYXRlKCkvMTAwMCk7ICAgICAgICBcbiAgICAgICAgcmV0dXJuIFwic3VjY2Vzc1wiO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgbG9nLmRlYnVnKFwiTG9nOiB7fVwiLCBlKTtcbiAgICAgICAgcmV0dXJuIFwiZXJyb3IucmVsZWFzZVwiO1xuICAgIH0gICAgICAgIFxufVxuIl19