"use strict";
var Capabilities;
(function (Capabilities) {
    Capabilities["REL1XX"] = "REL1XX";
    Capabilities["FORKING"] = "FORKING";
    Capabilities["PRECONDITION"] = "PRECONDITION";
    Capabilities["PEM"] = "PEM";
    Capabilities["UPDATE"] = "UPDATE";
})(Capabilities || (Capabilities = {}));
var Annotype;
(function (Annotype) {
    Annotype["CONNECT"] = "CONNECT";
    Annotype["RINGING"] = "RING";
})(Annotype || (Annotype = {}));
var CallPollActionType;
(function (CallPollActionType) {
    CallPollActionType["Accept"] = "accept";
    CallPollActionType["Forward"] = "forward";
    CallPollActionType["Reject"] = "reject";
})(CallPollActionType || (CallPollActionType = {}));
var CallStartActionType;
(function (CallStartActionType) {
    CallStartActionType[CallStartActionType["Abort"] = 0] = "Abort";
    CallStartActionType[CallStartActionType["Forward"] = 1] = "Forward";
    CallStartActionType[CallStartActionType["RejectMrf"] = 2] = "RejectMrf";
})(CallStartActionType || (CallStartActionType = {}));
var MediaOperationActionType;
(function (MediaOperationActionType) {
    MediaOperationActionType["PerformMediaOperation"] = "performMediaOperation";
})(MediaOperationActionType || (MediaOperationActionType = {}));
var MediaOperationContentType;
(function (MediaOperationContentType) {
    MediaOperationContentType["MSML"] = "application/msml+xml";
})(MediaOperationContentType || (MediaOperationContentType = {}));
;
;
function inputvalidation(session, event, localParams) {
    var log = session.log;
    try {
        if (session["s_SIPInvite"] != null) {
            if (session["s_SIPInvite"]["event-type"] !== null && (session["s_SIPInvite"]["event-type"] === "sip" || session["s_SIPInvite"]["event-type"] === "occp")) {
                if (session["s_SIPInvite"]["event-name"] !== null && session["s_SIPInvite"]["event-name"] === "sip.callStart.NONE")
                    log.debug("got sip invite");
                else
                    return "error.input.sipinviteincorrecteventname";
            }
            else {
                return "error.input.sipinviteincorrecteventtype";
            }
        }
        else {
            return "error.input.sipinvitemissing";
        }
        if (event["announcement"] != null) {
            log.debug("announcement: {}", event["announcement"]);
            session["mrf"]["announcement"] = event["announcement"];
        }
        else {
            return "error.input.actionmissing";
        }
        if ((event["action"] != null) && ((event["action"] === "promptandcollect") || (event["action"] === "playannouncement"))) {
            log.debug("action: {}", event["action"]);
            if (event["action"] === "promptandcollect")
                session["mrf"]["action"] = "promptandcollect";
            else if (event["action"] === "playannouncement")
                session["mrf"]["action"] = "playannouncement";
            else
                return "error.input.actionincorrect";
        }
        else {
            return "error.input.actionmissing";
        }
        if (event["earlydialog"] != null) {
            log.debug("earlydialog: {}", event["earlydialog"]);
            if (event["earlydialog"] === true) {
                session["mrf"]["earlydialog"] = true;
                return "true";
            }
            else if (event["earlydialog"] === false) {
                session["mrf"]["earlydialog"] = false;
                return "false";
            }
            else {
                return "error.input.earlydialogincorrect";
            }
        }
        else {
            return "error.input.earlydialog";
        }
    }
    catch (e) {
        log.debug("Log: {}", e);
        return "error.exception";
    }
}
function handle200OKINVITE(session, event, localParams) {
    var log = session.log;
    try {
        var eventData = localParams.message;
        session["mrf"]["headerrulevar=null"];
        session["mrf"]["headerrulesselect"] = null;
        session["mrf"]["ringingtones"] = null;
        var pollAction = void 0;
        pollAction = pollAction || {};
        pollAction.type = CallPollActionType.Accept;
        session["mrf"]["sendAction"] = JSON.stringify(pollAction);
        session["mrf"]["time200OKINVITE"] = Math.floor(new Date() / 1000);
        var to = eventData.SIP.To;
        if (to != null) {
            log.debug("received from MRF to tag:{}", to);
            session["mrf"]["callstate"] = "MRFCONNECTED200OK";
            session["mrf"]["downStreamToTag"] = to.tag;
            return "success";
        }
        else {
            log.debug("received from MRF no to tag:{}", to);
            return "error.nototag";
        }
    }
    catch (e) {
        log.debug("Log: {}", e);
        return "error.exception";
    }
}
function handle200OKINFO(session, event, localParams) {
    var log = session.log;
    try {
        session["mrf"]["time200OKINFO"] = Math.floor(new Date() / 1000);
        session["mrf"]["callstate"] = "MRFCONNECTED";
        if (event.SIP.content.json.msml.event.name[2] != null) {
            if (event.SIP.content.json.msml.event.name[2] == "dtmf.digits") {
                log.debug("Got DTMF digits;");
                if (event.SIP.content.json.msml.event.value[1] != null) {
                    session["mrf"]["dtmfdigit"] = event.SIP.content.json.msml.event.value[1];
                }
                else {
                    session["mrf"]["dtmfdigit"] = "0";
                }
            }
            else {
                log.debug("No DTMF digits;");
            }
        }
    }
    catch (e) {
        log.debug("Log: {}", e);
        return "error.exception";
    }
    return session["mrf"]["dtmfdigit"];
}
function callAnswered(session, event, localParams) {
    var log = session.log;
    try {
        session["mrf"]["callstate"] = "ANSWERED";
        session["mrf"]["answertime"] = Math.floor(new Date() / 1000);
        return "success";
    }
    catch (e) {
        log.debug("Log: {}", e);
        return "error.exception";
    }
}
function checkDisconnectReason(session, event, localParams) {
    var log = session.log;
    try {
        session["mrf"]["callstate"] = "ConnectError";
        session["mrf"]["connecterrortime"] = Math.floor(new Date() / 1000);
        var eventsStack = event['events-stack'];
        if (eventsStack != null && eventsStack.size() > 0) {
            for (var i = eventsStack.size() - 1; i >= 0; i--) {
                if (eventsStack.get(i).equals("leg.timeout") && i >= (eventsStack.size() - 2)) {
                    session.loginfo = session.loginfo + "TIMEOUT;";
                    return "error.mrf.connect.timeout";
                }
            }
        }
    }
    catch (e) {
        log.debug("Log: {}", e);
        return "error.mrf.connect.exception";
    }
    return "error.mrf.connect.others";
}
function setrelease(session, event, localParams) {
    var log = session.log;
    try {
        session["mrf"]["callstate"] = "Released";
        session["mrf"]["releasetime"] = Math.floor(new Date() / 1000);
        return "success";
    }
    catch (e) {
        log.debug("Log: {}", e);
        return "error.release";
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kdWxlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibW9kdWxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFVQSxJQUFLLFlBTUo7QUFORCxXQUFLLFlBQVk7SUFDZixpQ0FBaUIsQ0FBQTtJQUNqQixtQ0FBa0IsQ0FBQTtJQUNsQiw2Q0FBMkIsQ0FBQTtJQUMzQiwyQkFBUyxDQUFBO0lBQ1QsaUNBQWUsQ0FBQTtBQUNqQixDQUFDLEVBTkksWUFBWSxLQUFaLFlBQVksUUFNaEI7QUFzREQsSUFBSyxRQUdKO0FBSEQsV0FBSyxRQUFRO0lBQ1gsK0JBQW1CLENBQUE7SUFDbkIsNEJBQWdCLENBQUE7QUFDbEIsQ0FBQyxFQUhJLFFBQVEsS0FBUixRQUFRLFFBR1o7QUF1QkQsSUFBSyxrQkFJSjtBQUpELFdBQUssa0JBQWtCO0lBQ3RCLHVDQUFpQixDQUFBO0lBQ2pCLHlDQUFtQixDQUFBO0lBQ25CLHVDQUFpQixDQUFBO0FBQ2xCLENBQUMsRUFKSSxrQkFBa0IsS0FBbEIsa0JBQWtCLFFBSXRCO0FBRUQsSUFBSyxtQkFJSjtBQUpELFdBQUssbUJBQW1CO0lBQ3ZCLCtEQUFTLENBQUE7SUFDVCxtRUFBVyxDQUFBO0lBQ1gsdUVBQWEsQ0FBQTtBQUNkLENBQUMsRUFKSSxtQkFBbUIsS0FBbkIsbUJBQW1CLFFBSXZCO0FBZ0NELElBQUssd0JBRUo7QUFGRCxXQUFLLHdCQUF3QjtJQUM1QiwyRUFBK0MsQ0FBQTtBQUNoRCxDQUFDLEVBRkksd0JBQXdCLEtBQXhCLHdCQUF3QixRQUU1QjtBQUVELElBQUsseUJBRUo7QUFGRCxXQUFLLHlCQUF5QjtJQUM3QiwwREFBNkIsQ0FBQTtBQUM5QixDQUFDLEVBRkkseUJBQXlCLEtBQXpCLHlCQUF5QixRQUU3QjtBQW1GRCxDQUFDO0FBQ0QsQ0FBQztBQTRCRCxTQUFTLGVBQWUsQ0FBQyxPQUFhLEVBQUUsS0FBVyxFQUFFLFdBQWdCO0lBQ2pFLElBQUksR0FBRyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUM7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SUFBQyxPQUFPLENBQUMsRUFBRTtRQUNSLEdBQUcsQ0FBQyxLQUFLLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3hCLE9BQU8sZUFBZSxDQUFDO0tBQzFCO0FBQ0wsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vaW50ZXJmYWNlIGRlZmluaXRpb25cblxuaW50ZXJmYWNlIExlZyB7XG4gIGFkZHJlc3MgOiBzdHJpbmc7XG4gIG5hbWUgOiBzdHJpbmdcbn1cbmludGVyZmFjZSBDYWxsIHtcbiAgc3RhdGUgOiBudW1iZXJcbn1cblxuZW51bSBDYXBhYmlsaXRpZXMge1xuICBSRUwxWFggPSBcIlJFTDFYWFwiLFxuICBGT1JLSU5HPSBcIkZPUktJTkdcIixcbiAgUFJFQ09ORElUSU9OPVwiUFJFQ09ORElUSU9OXCIsXG4gIFBFTT1cIlBFTVwiLFxuICBVUERBVEU9XCJVUERBVEVcIlxufVxuXG5pbnRlcmZhY2UgTWVzc2FnZSB7XG4gIG1ldGhvZCA6IFtzdHJpbmddO1xuICB0eXBlIDogW3N0cmluZ107XG4gIGJvZHkgOiBbc3RyaW5nXVxufVxuXG5pbnRlcmZhY2UgU0lQIHtcbiAgY2FwYWJpbGl0aWVzIDogW0NhcGFiaWxpdGllc107XG4gIG1lc3NhZ2UgOiBNZXNzYWdlXG59XG5cbmludGVyZmFjZSBDYWxsU3RhcnQge1xuICBjb250YWN0IDogc3RyaW5nO1xuICBjYXVzZTogc3RyaW5nO1xuICBsZWcgOiBzdHJpbmdcbn1cblxuaW50ZXJmYWNlIENhbGxQb2xsIHtcbiAgbmFtZTogc3RyaW5nO1xuICB0eXBlOiBzdHJpbmc7XG4gIGxlZzogc3RyaW5nXG59XG5cbmludGVyZmFjZSBFdmVudCB7XG4gIG5hbWUgOiBzdHJpbmc7XG4gIGNhbGxTdGFydD8gOiBDYWxsU3RhcnQ7XG4gIGNhbGxQb2xsPyA6IENhbGxQb2xsXG59XG5cblxuaW50ZXJmYWNlIE9DQ1BFdmVudCB7XG4gIGNhbGxpZCA6IHN0cmluZztcbiAgY2FsbCA6IENhbGw7XG4gIGFzIDogc3RyaW5nO1xuICBldmVudHRpbWUgOiBudW1iZXI7XG4gIFNJUCA6IFNJUDtcbiAgZXZlbnQ6IEV2ZW50XG59XG5cbmludGVyZmFjZSBFdmVudHMge1xuICBTdWNjZXNzUmVzcG9uc2VQb2xsRXZlbnQ/IDogc3RyaW5nO1xuICBSYXdDb250ZW50UG9sbEV2ZW50PyA6IHN0cmluZztcbiAgSW5mb1BvbGxFdmVudD86IHN0cmluZ1xufVxuLyoqXG4gIERlZmluZSBoZWFkZXIgdmFyaWFibGVzIHVzZWQgYnkgYXBwbGljYXRpb25cbiovXG5pbnRlcmZhY2UgSGVhZGVyVmFycyB7XG4gIGRpc2FibGVTZW5kRGVmYXVsdFJlYXNvbj8gOiBzdHJpbmc7XG4gIGRpc2FibGVTZW5kTm9BbnN3ZXJSZWFzb24/IDogc3RyaW5nXG59XG5cbmVudW0gQW5ub3R5cGUge1xuICBDT05ORUNUID0gXCJDT05ORUNUXCIsXG4gIFJJTkdJTkcgPSBcIlJJTkdcIlxufVxuXG5pbnRlcmZhY2UgUmluZ2luZ1RvbmUge1xuICBhbm5vX25hbWUgOiBzdHJpbmc7XG4gIGFubm9fdHlwZSA6IEFubm90eXBlXG59XG5cbmludGVyZmFjZSBTZXNzaW9uIHtcbiAgbG9nIDogYW55O1xuICBpbkNhcGFiaWxpdGllcyA6IFtDYXBhYmlsaXRpZXNdO1xuICBvdXRDYXBhYmlsaXRpZXM/IDogc3RyaW5nO1xuICBldmVudHM/IDogc3RyaW5nO1xuICBoZWFkZXJydWxldmFyPyA6IHN0cmluZztcbiAgaGVhZGVycnVsZXNzZWxlY3Q/IDogc3RyaW5nO1xuICByaW5naW5ndG9uZXM/IDogc3RyaW5nO1xuICBzZW5kQWN0aW9uPyA6IHN0cmluZyA7XG4gIFNJUEhlbHBlciA6IGFueTtcbiAgU0lQSW5pdGlhbEludml0ZT8gOiBhbnk7XG4gIFNJUE1lc3NhZ2U/IDogYW55O1xuICBTSVBNZXNzYWdlVHlwZT8gOiBhbnlcbn1cblxuXG5lbnVtIENhbGxQb2xsQWN0aW9uVHlwZSB7XG4gQWNjZXB0ID0gXCJhY2NlcHRcIixcbiBGb3J3YXJkID0gXCJmb3J3YXJkXCIsXG4gUmVqZWN0ID0gXCJyZWplY3RcIixcbn1cblxuZW51bSBDYWxsU3RhcnRBY3Rpb25UeXBlIHtcbiBBYm9ydCA9IDAsXG4gRm9yd2FyZCA9IDEsXG4gUmVqZWN0TXJmID0gMlxufVxuXG5cblxuLyoqXG4gU2V0IGFjdGlvbiBmb3IgQ2FsbFN0YXJ0IGV2ZW50XG4qL1xuaW50ZXJmYWNlIENhbGxTdGFydEFjdGlvbiB7XG4gdHlwZSA6IENhbGxTdGFydEFjdGlvblR5cGU7XG4gZXJyb3Jjb2RlIDogbnVtYmVyO1xuIGNhdXNlIDogc3RyaW5nIDtcbiB1cmkgOiBzdHJpbmc7XG4gZWFybHltZWRpYSA6IG51bWJlcjtcbiBsZWduYW1lIDogc3RyaW5nIFxufVxuXG4vKipcbiBTZXQgYWN0aW9uIGZvciBDYWxsUG9sbCBldmVudFxuKi9cbmludGVyZmFjZSBDYWxsUG9sbEFjdGlvbiB7XG4gdHlwZSA6IENhbGxQb2xsQWN0aW9uVHlwZVxufVxuXG5cbi8qKlxuIEFwcGxpY2F0aW9uIGNhbiBzZXQgYWN0aW9uIGZvciBhIHNwZWNpZmljIGxlZywgdGhpcyBpcyBhcHBsaWNhYmxlIGZvciBNUkYgY29udGFjdFxuICovXG5pbnRlcmZhY2UgTGVnQWN0aW9uIHtcbiB0eXBlIDogQ2FsbFN0YXJ0QWN0aW9uVHlwZSA7XG4gbGVnYWN0aW9uIDogc3RyaW5nXG59XG5cbmVudW0gTWVkaWFPcGVyYXRpb25BY3Rpb25UeXBlIHtcbiBQZXJmb3JtTWVkaWFPcGVyYXRpb24gPSBcInBlcmZvcm1NZWRpYU9wZXJhdGlvblwiXG59XG5cbmVudW0gTWVkaWFPcGVyYXRpb25Db250ZW50VHlwZSB7XG4gTVNNTCA9IFwiYXBwbGljYXRpb24vbXNtbCt4bWxcIlxufVxuXG5pbnRlcmZhY2UgUGVyZm9ybU1lZGlhT3BlcmF0aW9uIHtcbiBDb250ZW50VHlwZSA6IE1lZGlhT3BlcmF0aW9uQ29udGVudFR5cGU7XG4gQ29udGVudCA6IHN0cmluZ1xufVxuXG5pbnRlcmZhY2UgTWVkaWFPcGVyYXRpb25BY3Rpb24ge1xuIHR5cGUgOiBudW1iZXI7XG4gbGVnYWN0aW9uIDogTWVkaWFPcGVyYXRpb25BY3Rpb25UeXBlO1xuIHBlcmZvcm1NZWRpYU9wZXJhdGlvbiA6IFBlcmZvcm1NZWRpYU9wZXJhdGlvblxufVxuXG5pbnRlcmZhY2UgQWN0aW9uIHtcbiBhY3Rpb24gOiBhbnkgXG59XG5cblxuaW50ZXJmYWNlIEhlYWRlciB7XG4gaGVhZGVyIDogc3RyaW5nO1xuIHZhbHVlIDogc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgUUhlYWRlciB7XG4gUHJpdmFjeSA6IHN0cmluZztcbiBSZWFzb24gOiBzdHJpbmcgO1xufVxuXG5pbnRlcmZhY2UgUGFyYW1ldGVyIHtcbiB0cmFuc3BvcnQgOiBzdHJpbmc7XG4gdXNlciA6IHN0cmluZyA7XG59XG5cbmludGVyZmFjZSBVUkkge1xuIHNjaGVtZSA6IHN0cmluZztcbiBhdXRob3JpdHkgOiBzdHJpbmcgO1xuIGdyIDogc3RyaW5nIDtcbiBob3N0OiBzdHJpbmcgO1xuIGxyIDogc3RyaW5nIDtcbiBtYWRkciA6IHN0cmluZyA7XG4gcG9ydCA6IG51bWJlciAgO1xuIHVzZXIgOiBzdHJpbmcgO1xuIHBhcmFtZXRlcnMgOiBbUGFyYW1ldGVyXTtcbiBxaGVhZGVyIDogW1FIZWFkZXJdO1xufVxuXG5pbnRlcmZhY2UgQWRkcmVzcyB7XG4gZGlzcGxheU5hbWUgOiBzdHJpbmc7XG4gdXJpIDogVVJJIFxufVxuXG5pbnRlcmZhY2UgSGlzdG9yeUluZm8gaW1wbGVtZW50cyBIZWFkZXIge1xuIGFkZHJlc3MgOiBBZGRyZXNzO1xuIGluZGV4IDogc3RyaW5nXG59XG5cbmludGVyZmFjZSBQQUkgaW1wbGVtZW50cyBIZWFkZXIgIHtcbiBhZGRyZXNzIDogQWRkcmVzc1xufVxuXG5pbnRlcmZhY2UgRnJvbSBpbXBsZW1lbnRzIEhlYWRlciB7XG4gYWRkcmVzcyA6IEFkZHJlc3M7XG4gdGFnIDogc3RyaW5nIDtcbn1cblxuaW50ZXJmYWNlIFRvIGltcGxlbWVudHMgSGVhZGVyIHtcbiBhZGRyZXNzIDogQWRkcmVzcztcbiB0YWcgOiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBQQ1YgaW1wbGVtZW50cyBIZWFkZXIge1xuIGljaWRfZ2VuZXJhdGVkX2F0OiBzdHJpbmcgO1xuIGljaWRfdmFsdWUgOiBzdHJpbmcgO1xuIG9haWQgOiBzdHJpbmc7XG4gdGFpZCA6IHN0cmluZztcbiBvc2lkIDogc3RyaW5nO1xuIHRzaWQgOiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBSZXN1bHRDb2RlIHtcbiAgcmVzdWx0Q29kZSA6IHN0cmluZyA7XG59XG5cbjsvL01BSU5CTE9DS1xuO1xyXG4vKlxyXG4vL2NvbmZpZyBpcyBcIm1yZl9hbm5vdW5jZW1lbnRzXCJcclxue1xyXG4gIFwiYW5ub1Rlc3RcIjoge1xyXG4gICAgXCJtYXh0aW1lXCI6IDE1MDAsXHJcbiAgICBcInBhdGhcIjogXCJmaWxlOi8vL3RtcC9hbm5vcy9cIixcclxuICAgIFwidmFyaWFibGVcIjogXCJcIixcclxuICAgIFwiYmFyZ2VcIjogMSxcclxuICAgIFwicHJvbXB0XCI6IFwidGVzdEFubm8ud2F2XCIsXHJcbiAgICBcImR0bWZcIjoge1xyXG4gICAgICBcImNsZWFyZGJcIjogMSxcclxuICAgICAgXCJpZHRcIjogMSxcclxuICAgICAgXCJmZHRcIjogMSxcclxuICAgICAgXCJtaW5cIjogMSxcclxuICAgICAgXCJtYXhcIjogMSxcclxuICAgICAgXCJydGZcIjogXCIqXCIsXHJcbiAgICAgIFwiY2FuY2VsXCI6IFwiI1wiXHJcbiAgICB9LFxyXG4gICAgXCJhbm5pZFwiOiBcImFubm9Qcm9tcHRDb2xsZWN0XCIsXHJcbiAgICBcImludGVydmFsXCI6IDEwMCxcclxuICAgIFwiaXRlcmF0ZVwiOiAxLFxyXG4gICAgXCJjbGVhcmRiXCI6IDFcclxuICB9LFxyXG59XHJcblxyXG4qL1xyXG5cclxuZnVuY3Rpb24gaW5wdXR2YWxpZGF0aW9uKHNlc3Npb24gOiBhbnksIGV2ZW50IDogYW55LCBsb2NhbFBhcmFtczogYW55ICl7XHJcbiAgICBsZXQgbG9nID0gc2Vzc2lvbi5sb2c7XHJcblxyXG4gICAgdHJ5IHtcclxuXHJcbiAgICAgICAgLy9zaXAgaW52aXRlIGlzIGluICNzZXNzaW9uW1wic19TSVBJbnZpdGVcIl1cclxuICAgICAgICBpZiAoIHNlc3Npb25bXCJzX1NJUEludml0ZVwiXSAhPSBudWxsICkge1xyXG4gICAgICAgICAgICBpZiggc2Vzc2lvbltcInNfU0lQSW52aXRlXCJdW1wiZXZlbnQtdHlwZVwiXSE9PW51bGwgJiYgKHNlc3Npb25bXCJzX1NJUEludml0ZVwiXVtcImV2ZW50LXR5cGVcIl09PT1cInNpcFwiIHx8IHNlc3Npb25bXCJzX1NJUEludml0ZVwiXVtcImV2ZW50LXR5cGVcIl09PT1cIm9jY3BcIikpIHtcclxuICAgICAgICAgICAgICAgIGlmKCBzZXNzaW9uW1wic19TSVBJbnZpdGVcIl1bXCJldmVudC1uYW1lXCJdIT09bnVsbCAmJiBzZXNzaW9uW1wic19TSVBJbnZpdGVcIl1bXCJldmVudC1uYW1lXCJdID09PSBcInNpcC5jYWxsU3RhcnQuTk9ORVwiKVxyXG4gICAgICAgICAgICAgICAgICAgIGxvZy5kZWJ1ZyhcImdvdCBzaXAgaW52aXRlXCIpO1xyXG4gICAgICAgICAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBcImVycm9yLmlucHV0LnNpcGludml0ZWluY29ycmVjdGV2ZW50bmFtZVwiO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFwiZXJyb3IuaW5wdXQuc2lwaW52aXRlaW5jb3JyZWN0ZXZlbnR0eXBlXCI7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gXCJlcnJvci5pbnB1dC5zaXBpbnZpdGVtaXNzaW5nXCI7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvL2Fubm91bmNlbWVudCBzdHJpbmdcclxuICAgICAgICBpZiAoIGV2ZW50W1wiYW5ub3VuY2VtZW50XCJdICE9IG51bGwgKSB7XHJcbiAgICAgICAgICAgIGxvZy5kZWJ1ZyhcImFubm91bmNlbWVudDoge31cIiwgZXZlbnRbXCJhbm5vdW5jZW1lbnRcIl0pO1xyXG4gICAgICAgICAgICAgICAgc2Vzc2lvbltcIm1yZlwiXVtcImFubm91bmNlbWVudFwiXSA9IGV2ZW50W1wiYW5ub3VuY2VtZW50XCJdOyAgICAgICAgICAgXHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIFwiZXJyb3IuaW5wdXQuYWN0aW9ubWlzc2luZ1wiO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy9wcm9tcHRhbmRjb2xsZWN0LCBwbGF5YW5ub3VuY2VtZW50XHJcbiAgICAgICAgaWYgKCAoZXZlbnRbXCJhY3Rpb25cIl0gIT0gbnVsbCkgJiYgKChldmVudFtcImFjdGlvblwiXT09PVwicHJvbXB0YW5kY29sbGVjdFwiKSB8fCAoZXZlbnRbXCJhY3Rpb25cIl09PT1cInBsYXlhbm5vdW5jZW1lbnRcIikpICkge1xyXG4gICAgICAgICAgICBsb2cuZGVidWcoXCJhY3Rpb246IHt9XCIsIGV2ZW50W1wiYWN0aW9uXCJdKTtcclxuICAgICAgICAgICAgaWYgKCBldmVudFtcImFjdGlvblwiXT09PVwicHJvbXB0YW5kY29sbGVjdFwiICkgXHJcbiAgICAgICAgICAgICAgICBzZXNzaW9uW1wibXJmXCJdW1wiYWN0aW9uXCJdID0gXCJwcm9tcHRhbmRjb2xsZWN0XCI7XHJcbiAgICAgICAgICAgIGVsc2UgaWYgKCBldmVudFtcImFjdGlvblwiXT09PVwicGxheWFubm91bmNlbWVudFwiICkgXHJcbiAgICAgICAgICAgICAgICBzZXNzaW9uW1wibXJmXCJdW1wiYWN0aW9uXCJdID0gXCJwbGF5YW5ub3VuY2VtZW50XCI7XHJcbiAgICAgICAgICAgIGVsc2VcclxuICAgICAgICAgICAgICAgIHJldHVybiBcImVycm9yLmlucHV0LmFjdGlvbmluY29ycmVjdFwiOyAgICAgICAgICAgIFxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJldHVybiBcImVycm9yLmlucHV0LmFjdGlvbm1pc3NpbmdcIjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vZWFybHkgZGlhbG9nIGlzIGJvb2xlYW4gdHJ1ZS9mYWxzZVxyXG4gICAgICAgIGlmICggZXZlbnRbXCJlYXJseWRpYWxvZ1wiXSAhPSBudWxsICkge1xyXG4gICAgICAgICAgICBsb2cuZGVidWcoXCJlYXJseWRpYWxvZzoge31cIiwgZXZlbnRbXCJlYXJseWRpYWxvZ1wiXSk7XHJcbiAgICAgICAgICAgIGlmICggZXZlbnRbXCJlYXJseWRpYWxvZ1wiXSA9PT0gdHJ1ZSkge1xyXG4gICAgICAgICAgICAgICAgc2Vzc2lvbltcIm1yZlwiXVtcImVhcmx5ZGlhbG9nXCJdID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBcInRydWVcIjtcclxuICAgICAgICAgICAgfSBlbHNlIGlmICggZXZlbnRbXCJlYXJseWRpYWxvZ1wiXSA9PT0gZmFsc2UpIHtcclxuICAgICAgICAgICAgICAgIHNlc3Npb25bXCJtcmZcIl1bXCJlYXJseWRpYWxvZ1wiXSA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIFwiZmFsc2VcIjtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBcImVycm9yLmlucHV0LmVhcmx5ZGlhbG9naW5jb3JyZWN0XCI7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gXCJlcnJvci5pbnB1dC5lYXJseWRpYWxvZ1wiO1xyXG4gICAgICAgIH1cclxuICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICBsb2cuZGVidWcoXCJMb2c6IHt9XCIsIGUpO1xyXG4gICAgICAgIHJldHVybiBcImVycm9yLmV4Y2VwdGlvblwiO1xyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBoYW5kbGUyMDBPS0lOVklURShzZXNzaW9uOmFueSxldmVudDpPQ0NQU0lQLk9DQ1BFdmVudCxsb2NhbFBhcmFtczphbnkpIHtcclxuICAgIGxldCBsb2cgPSBzZXNzaW9uLmxvZztcclxuXHJcbiAgICB0cnkge1xyXG4gICAgICAgIC8vdGhlIHJlY2VpdmVkIGV2ZW50IGlzIG5vdyBpbiBsb2NhbFBhcmFtc1xyXG4gICAgICAgIGxldCBldmVudERhdGEgPSBsb2NhbFBhcmFtcy5tZXNzYWdlO1xyXG4gICAgICAgIC8vc2Vzc2lvbi5ldmVudHMgPSBudWxsO1xyXG4gICAgICAgIHNlc3Npb25bXCJtcmZcIl1bXCJoZWFkZXJydWxldmFyPW51bGxcIl07XHJcbiAgICAgICAgc2Vzc2lvbltcIm1yZlwiXVtcImhlYWRlcnJ1bGVzc2VsZWN0XCJdID0gbnVsbDtcclxuICAgICAgICBzZXNzaW9uW1wibXJmXCJdW1wicmluZ2luZ3RvbmVzXCJdID0gbnVsbDtcclxuXHJcbiAgICAgICAgbGV0IHBvbGxBY3Rpb24gOiBDYWxsUG9sbEFjdGlvbjtcclxuICAgICAgICBwb2xsQWN0aW9uID0gcG9sbEFjdGlvbiB8fCB7fTtcclxuICAgICAgICBwb2xsQWN0aW9uLnR5cGUgPSBDYWxsUG9sbEFjdGlvblR5cGUuQWNjZXB0O1xyXG4gICAgICAgIHNlc3Npb25bXCJtcmZcIl1bXCJzZW5kQWN0aW9uXCJdID0gSlNPTi5zdHJpbmdpZnkocG9sbEFjdGlvbik7XHJcblxyXG4gICAgICAgIHNlc3Npb25bXCJtcmZcIl1bXCJ0aW1lMjAwT0tJTlZJVEVcIl0gID0gTWF0aC5mbG9vcihuZXcgRGF0ZSgpLzEwMDApO1xyXG5cclxuICAgICAgICAvL3NhdmUgdG8gdGFnXHJcbiAgICAgICAgbGV0IHRvIDogVG8gPSBldmVudERhdGEuU0lQLlRvO1xyXG4gICAgICAgIGlmKCB0byE9bnVsbCkge1xyXG4gICAgICAgICAgICBsb2cuZGVidWcoXCJyZWNlaXZlZCBmcm9tIE1SRiB0byB0YWc6e31cIix0byk7XHJcbiAgICAgICAgICAgIHNlc3Npb25bXCJtcmZcIl1bXCJjYWxsc3RhdGVcIl0gID0gXCJNUkZDT05ORUNURUQyMDBPS1wiO1xyXG4gICAgICAgICAgICBzZXNzaW9uW1wibXJmXCJdW1wiZG93blN0cmVhbVRvVGFnXCJdPXRvLnRhZztcclxuICAgICAgICAgICAgcmV0dXJuIFwic3VjY2Vzc1wiO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGxvZy5kZWJ1ZyhcInJlY2VpdmVkIGZyb20gTVJGIG5vIHRvIHRhZzp7fVwiLHRvKTtcclxuICAgICAgICAgICAgcmV0dXJuIFwiZXJyb3Iubm90b3RhZ1wiO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICBsb2cuZGVidWcoXCJMb2c6IHt9XCIsIGUpO1xyXG4gICAgICAgIHJldHVybiBcImVycm9yLmV4Y2VwdGlvblwiO1xyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBoYW5kbGUyMDBPS0lORk8oc2Vzc2lvbjphbnksZXZlbnQ6T0NDUFNJUC5FdmVudCxsb2NhbFBhcmFtczpMb2NhbFBhcmFtZXRlcnMpOiBhbnl7XHJcbiAgICBsZXQgbG9nID0gc2Vzc2lvbi5sb2c7XHJcblxyXG4gICAgdHJ5IHsgICAgICAgIFxyXG4gICAgICAgIHNlc3Npb25bXCJtcmZcIl1bXCJ0aW1lMjAwT0tJTkZPXCJdICA9IE1hdGguZmxvb3IobmV3IERhdGUoKS8xMDAwKTtcclxuICAgICAgICBzZXNzaW9uW1wibXJmXCJdW1wiY2FsbHN0YXRlXCJdICA9IFwiTVJGQ09OTkVDVEVEXCI7XHJcbiAgICAgICAgaWYgKGV2ZW50LlNJUC5jb250ZW50Lmpzb24ubXNtbC5ldmVudC5uYW1lWzJdIT1udWxsKSB7XHJcbiAgICAgICAgICAgIGlmIChldmVudC5TSVAuY29udGVudC5qc29uLm1zbWwuZXZlbnQubmFtZVsyXT09XCJkdG1mLmRpZ2l0c1wiKSB7XHJcbiAgICAgICAgICAgICAgICBsb2cuZGVidWcoXCJHb3QgRFRNRiBkaWdpdHM7XCIpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGV2ZW50LlNJUC5jb250ZW50Lmpzb24ubXNtbC5ldmVudC52YWx1ZVsxXSE9bnVsbCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHNlc3Npb25bXCJtcmZcIl1bXCJkdG1mZGlnaXRcIl09ZXZlbnQuU0lQLmNvbnRlbnQuanNvbi5tc21sLmV2ZW50LnZhbHVlWzFdOyAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2Vzc2lvbltcIm1yZlwiXVtcImR0bWZkaWdpdFwiXT1cIjBcIjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGxvZy5kZWJ1ZyhcIk5vIERUTUYgZGlnaXRzO1wiKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICBsb2cuZGVidWcoXCJMb2c6IHt9XCIsIGUpO1xyXG4gICAgICAgIHJldHVybiBcImVycm9yLmV4Y2VwdGlvblwiO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHNlc3Npb25bXCJtcmZcIl1bXCJkdG1mZGlnaXRcIl07XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNhbGxBbnN3ZXJlZChzZXNzaW9uIDogYW55LCBldmVudCA6IGFueSwgbG9jYWxQYXJhbXM6IGFueSApe1xyXG4gICAgbGV0IGxvZyA9IHNlc3Npb24ubG9nO1xyXG5cclxuICAgIHRyeSB7ICAgICAgICBcclxuICAgICAgICBzZXNzaW9uW1wibXJmXCJdW1wiY2FsbHN0YXRlXCJdICA9IFwiQU5TV0VSRURcIjtcclxuICAgICAgICBzZXNzaW9uW1wibXJmXCJdW1wiYW5zd2VydGltZVwiXSAgPSBNYXRoLmZsb29yKG5ldyBEYXRlKCkvMTAwMCk7XHJcbiAgICAgICAgcmV0dXJuIFwic3VjY2Vzc1wiO1xyXG4gICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgIGxvZy5kZWJ1ZyhcIkxvZzoge31cIiwgZSk7XHJcbiAgICAgICAgcmV0dXJuIFwiZXJyb3IuZXhjZXB0aW9uXCI7XHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNoZWNrRGlzY29ubmVjdFJlYXNvbihzZXNzaW9uIDogYW55LCBldmVudCA6IGFueSwgbG9jYWxQYXJhbXM6IGFueSApe1xyXG4gICAgbGV0IGxvZyA9IHNlc3Npb24ubG9nO1xyXG5cclxuICAgIHRyeSB7ICBcclxuICAgICAgICBzZXNzaW9uW1wibXJmXCJdW1wiY2FsbHN0YXRlXCJdICA9IFwiQ29ubmVjdEVycm9yXCI7XHJcbiAgICAgICAgc2Vzc2lvbltcIm1yZlwiXVtcImNvbm5lY3RlcnJvcnRpbWVcIl0gID0gTWF0aC5mbG9vcihuZXcgRGF0ZSgpLzEwMDApOyAgICAgICAgXHJcbiAgICAgICAgbGV0IGV2ZW50c1N0YWNrPWV2ZW50WydldmVudHMtc3RhY2snXTtcclxuICAgICAgICBpZiggZXZlbnRzU3RhY2shPW51bGwgJiYgZXZlbnRzU3RhY2suc2l6ZSgpPjAgKXtcclxuICAgICAgICAgICAgZm9yKHZhciBpPWV2ZW50c1N0YWNrLnNpemUoKS0xO2k+PTA7aS0tKXtcclxuICAgICAgICAgICAgICAgIGlmKCBldmVudHNTdGFjay5nZXQoaSkuZXF1YWxzKFwibGVnLnRpbWVvdXRcIikgJiYgaT49KGV2ZW50c1N0YWNrLnNpemUoKS0yKSl7XHJcbiAgICAgICAgICAgICAgICAgICAgc2Vzc2lvbi5sb2dpbmZvID0gc2Vzc2lvbi5sb2dpbmZvK1wiVElNRU9VVDtcIjsgXHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFwiZXJyb3IubXJmLmNvbm5lY3QudGltZW91dFwiOyAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgIGxvZy5kZWJ1ZyhcIkxvZzoge31cIiwgZSk7XHJcbiAgICAgICAgcmV0dXJuIFwiZXJyb3IubXJmLmNvbm5lY3QuZXhjZXB0aW9uXCI7XHJcbiAgICB9ICAgICAgICBcclxuICAgIHJldHVybiBcImVycm9yLm1yZi5jb25uZWN0Lm90aGVyc1wiO1xyXG59XHJcblxyXG5mdW5jdGlvbiBzZXRyZWxlYXNlKHNlc3Npb24gOiBhbnksIGV2ZW50IDogYW55LCBsb2NhbFBhcmFtczogYW55ICl7XHJcbiAgICBsZXQgbG9nID0gc2Vzc2lvbi5sb2c7XHJcblxyXG4gICAgdHJ5IHsgIFxyXG4gICAgICAgIHNlc3Npb25bXCJtcmZcIl1bXCJjYWxsc3RhdGVcIl0gID0gXCJSZWxlYXNlZFwiO1xyXG4gICAgICAgIHNlc3Npb25bXCJtcmZcIl1bXCJyZWxlYXNldGltZVwiXSAgPSBNYXRoLmZsb29yKG5ldyBEYXRlKCkvMTAwMCk7ICAgICAgICBcclxuICAgICAgICByZXR1cm4gXCJzdWNjZXNzXCI7XHJcbiAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgbG9nLmRlYnVnKFwiTG9nOiB7fVwiLCBlKTtcclxuICAgICAgICByZXR1cm4gXCJlcnJvci5yZWxlYXNlXCI7XHJcbiAgICB9ICAgICAgICBcclxufVxyXG5cclxuXHJcbiJdfQ==